{% extends 'base.html' %}
{% load static %}

{% block title %}My Milestones - MyRecoveryPal{% endblock %}

{% block extra_css %}
<style>
    .milestones-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 2rem;
    }

    .milestones-header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .milestones-header-content h2 {
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .milestones-header-content p {
        color: #666;
        margin: 0;
    }

    .add-milestone-btn-top {
        background: var(--accent-color);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-milestone-btn-top:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .milestone-timeline {
        position: relative;
        padding: 2rem 0;
    }

    .milestone-timeline::before {
        content: '';
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--primary-color);
        transform: translateX(-50%);
    }

    .milestone-item {
        background: white;
        padding: 2rem;
        margin-bottom: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: relative;
        width: calc(50% - 2rem);
    }

    .milestone-item:nth-child(odd) {
        margin-left: auto;
    }

    .milestone-item::before {
        content: '';
        position: absolute;
        top: 50%;
        width: 20px;
        height: 20px;
        background: var(--accent-color);
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .milestone-item:nth-child(odd)::before {
        left: -30px;
    }

    .milestone-item:nth-child(even)::before {
        right: -30px;
    }

    .milestone-type {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: var(--primary-color);
        color: white;
        border-radius: 20px;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }

    .milestone-date {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: #f8f9fa;
        border-radius: 10px;
        margin: 2rem 0;
    }

    .empty-state-icon {
        font-size: 3rem;
        color: #52b788;
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        color: #666;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #999;
        margin-bottom: 1.5rem;
    }

    /* Share buttons */
    .milestone-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #f0f0f0;
    }

    .share-label {
        font-size: 0.85rem;
        color: #666;
        margin-right: 0.25rem;
    }

    .share-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        text-decoration: none;
        color: white;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .share-btn:hover {
        transform: scale(1.1);
        color: white;
    }

    .share-btn.facebook { background: #1877f2; }
    .share-btn.twitter { background: #1da1f2; }
    .share-btn.linkedin { background: #0077b5; }
    .share-btn.whatsapp { background: #25d366; }
    .share-btn.native {
        background: linear-gradient(135deg, #4db8e8, #52b788);
        cursor: pointer;
        border: none;
    }
    .share-btn.copy {
        background: #666;
        cursor: pointer;
        border: none;
    }

    .share-btn.copy.copied,
    .share-btn.native.shared {
        background: #333;
    }

    /* Hide native share on desktop */
    @media (min-width: 769px) {
        .share-btn.native {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .milestones-header-section {
            flex-direction: column;
            text-align: center;
        }

        .milestones-header-content {
            margin-bottom: 1rem;
        }

        .milestone-item {
            width: 100%;
            margin-left: 0 !important;
        }

        .milestone-timeline::before {
            left: 20px;
        }

        .milestone-item::before {
            left: 10px !important;
            right: auto !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header milestones-header">
    <h1>My Recovery Milestones</h1>
    <p>Celebrating every step of your journey</p>
</div>

<div class="milestones-container">
    <div class="milestones-header-section">
        <div class="milestones-header-content">
            <h2>Your Achievements</h2>
            <p>Track and celebrate your recovery journey</p>
        </div>
        <a href="{% url 'accounts:add_milestone' %}" class="add-milestone-btn-top">
            <i class="fas fa-plus"></i> Add Milestone
        </a>
    </div>

    {% if milestones %}
    <div class="milestone-timeline">
        {% for milestone in milestones %}
        <div class="milestone-item">
            <span class="milestone-type">{{ milestone.display_milestone_type }}</span>
            <h3>{{ milestone.title }}</h3>
            {% if milestone.description %}
            <p>{{ milestone.description }}</p>
            {% endif %}
            <div class="milestone-date">
                <i class="fas fa-calendar"></i>
                {{ milestone.date_achieved|date:"F d, Y" }}
            </div>
            {% if milestone.milestone_type == 'days' and milestone.calculated_days_sober is not None %}
            <div class="milestone-date">
                <i class="fas fa-trophy"></i>
                {% if milestone.calculated_days_sober == 0 %}
                First day of sobriety
                {% else %}
                Achieved on day {{ milestone.calculated_days_sober|add:1 }} of recovery
                {% endif %}
            </div>
            {% endif %}

            <!-- Share buttons -->
            <div class="milestone-actions">
                <span class="share-label">Share:</span>
                {% with share_text="ðŸŽ‰ I just achieved a milestone in my recovery journey: "|add:milestone.title|add:" #Recovery #MyRecoveryPal" %}
                <button class="share-btn native" onclick="nativeShare('{{ milestone.title|escapejs }}', this)" title="Share">
                    <i class="fas fa-share-alt"></i>
                </button>
                <a href="https://www.facebook.com/sharer/sharer.php?quote={{ share_text|urlencode }}"
                   target="_blank" rel="noopener"
                   class="share-btn facebook" title="Share on Facebook">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="https://twitter.com/intent/tweet?text={{ share_text|urlencode }}"
                   target="_blank" rel="noopener"
                   class="share-btn twitter" title="Share on Twitter/X">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="https://wa.me/?text={{ share_text|urlencode }}%20{{ request.build_absolute_uri|urlencode }}"
                   target="_blank" rel="noopener"
                   class="share-btn whatsapp" title="Share on WhatsApp">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <button class="share-btn copy" onclick="copyMilestoneText('{{ milestone.title|escapejs }}', this)" title="Copy to clipboard">
                    <i class="fas fa-link"></i>
                </button>
                {% endwith %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <h3>No milestones yet</h3>
        <p>Start celebrating your achievements and track your recovery journey!</p>
        <a href="{% url 'accounts:add_milestone' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Your First Milestone
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Native Web Share API (mobile)
async function nativeShare(milestoneTitle, button) {
    const shareData = {
        title: 'My Recovery Milestone',
        text: `ðŸŽ‰ I just achieved a milestone in my recovery journey: ${milestoneTitle} #Recovery #MyRecoveryPal`,
        url: window.location.origin
    };

    if (navigator.share) {
        try {
            await navigator.share(shareData);
            button.classList.add('shared');
            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                button.classList.remove('shared');
                button.innerHTML = '<i class="fas fa-share-alt"></i>';
            }, 2000);
        } catch (err) {
            // User cancelled or error - do nothing
            console.log('Share cancelled or failed:', err);
        }
    } else {
        // Fallback to copy
        copyMilestoneText(milestoneTitle, button);
    }
}

// Copy to clipboard
function copyMilestoneText(milestoneTitle, button) {
    const shareText = `ðŸŽ‰ I just achieved a milestone in my recovery journey: ${milestoneTitle} #Recovery #MyRecoveryPal\n\nJoin the supportive community at ${window.location.origin}`;

    navigator.clipboard.writeText(shareText).then(() => {
        // Show success state
        button.classList.add('copied');
        button.innerHTML = '<i class="fas fa-check"></i>';

        // Reset after 2 seconds
        setTimeout(() => {
            button.classList.remove('copied');
            button.innerHTML = '<i class="fas fa-link"></i>';
        }, 2000);
    }).catch(err => {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = shareText;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);

        button.classList.add('copied');
        button.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            button.classList.remove('copied');
            button.innerHTML = '<i class="fas fa-link"></i>';
        }, 2000);
    });
}
</script>
{% endblock %}