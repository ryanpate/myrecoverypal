<!-- apps/accounts/templates/accounts/dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - MyRecoveryPal{% endblock %}
{% block meta_robots %}noindex, nofollow{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .main-feed {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .feed-header {
        padding: 1.5rem;
        border-bottom: 1px solid #f0f0f0;
        background: #f8f9fa;
    }

    .activity-feed {
        max-height: 800px;
        overflow-y: auto;
    }

    .activity-item {
        padding: 1.5rem;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.3s;
    }

    .activity-item:hover {
        background: #f8f9fa;
    }

    .activity-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .activity-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        color: #999;
        font-size: 1.5rem;
    }

    .activity-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .activity-content {
        flex: 1;
    }

    .activity-user {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
    }

    .activity-time {
        font-size: 0.85rem;
        color: #666;
    }

    .activity-description {
        margin: 1rem 0;
        line-height: 1.5;
    }

    .activity-engagement {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #f0f0f0;
    }

    .engagement-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .engagement-btn:hover {
        background: #f0f0f0;
        color: #52b788;
    }

    .engagement-btn.liked {
        color: #e74c3c;
        background: #fee;
    }

    .engagement-btn i {
        font-size: 1rem;
    }

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .sidebar-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    }

    .sidebar-section h3 {
        margin-bottom: 1rem;
        color: #333;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sidebar-section h3 i {
        color: #52b788;
    }

    .quick-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #52b788;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.85rem;
        color: #666;
    }

    .connection-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        border-radius: 8px;
        transition: background 0.3s;
    }

    .connection-item:hover {
        background: #f8f9fa;
    }

    .connection-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
        color: #999;
        font-size: 1.2rem;
    }

    .connection-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .connection-info {
        flex: 1;
        min-width: 0;
    }

    .connection-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .connection-status {
        font-size: 0.8rem;
        color: #666;
    }

    .engagement-count {
        font-size: 0.85rem;
        font-weight: 500;
        margin-left: 0.25rem;
    }
    .group-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        border-radius: 8px;
        transition: background 0.3s;
        text-decoration: none;
        color: inherit;
    }

    .group-item:hover {
        background: #f8f9fa;
        text-decoration: none;
        color: inherit;
    }

    .group-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: #52b788;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .checkin-form {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    .mood-selector {
        display: flex;
        gap: 0.5rem;
        margin: 1rem 0;
        flex-wrap: wrap;
    }

    .mood-option {
        padding: 0.5rem 1rem;
        border: 2px solid #ddd;
        border-radius: 25px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .mood-option i {
        font-size: 1.1rem;
    }

    .mood-option:hover {
        border-color: #52b788;
    }

    .mood-option.selected {
        background: #52b788;
        color: white;
        border-color: #52b788;
    }

    .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        color: #666;
        text-decoration: none;
        transition: all 0.3s;
        font-size: 0.9rem;
        justify-content: center;
    }

    .action-btn:hover {
        background: #f8f9fa;
        color: #52b788;
        border-color: #52b788;
        text-decoration: none;
        transform: translateY(-1px);
    }

    .action-btn i {
        font-size: 1rem;
    }

    .milestone-item {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 4px solid #52b788;
    }

    .milestone-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
    }

    .milestone-date {
        font-size: 0.85rem;
        color: #666;
    }

    .suggested-connection {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        margin-bottom: 0.75rem;
    }

    .suggestion-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        color: #999;
        font-size: 1.3rem;
    }

    .suggestion-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .suggestion-info {
        flex: 1;
        min-width: 0;
    }

    .suggestion-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .suggestion-reason {
        font-size: 0.8rem;
        color: #666;
    }

    .follow-suggestion-btn {
        background: #52b788;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .follow-suggestion-btn:hover {
        background: #45a374;
        transform: translateY(-1px);
    }

    .empty-feed {
        text-align: center;
        padding: 3rem 2rem;
        color: #666;
    }

    .empty-feed-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
        color: #52b788;
    }

    .activity-type-icon {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }

    /* Mobile Social Feed Styles */
    .mobile-social-feed {
        display: none; /* Hidden on desktop */
    }

    @media (max-width: 1024px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .sidebar {
            order: -1;
        }

        /* Show mobile social feed */
        .mobile-social-feed {
            display: block;
            order: 1; /* Show after sidebar but before main feed */
            margin-bottom: 2rem;
        }

        .mobile-feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .mobile-feed-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text-dark);
        }

        .mobile-create-post {
            background: white;
            padding: 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .mobile-post-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: #666;
        }

        .mobile-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .mobile-post-textarea {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: none;
            font-size: 1rem;
            padding: 0.75rem;
            min-height: 80px;
            font-family: inherit;
            outline: none;
            margin-bottom: 0.75rem;
        }

        .mobile-post-textarea:focus {
            border-color: var(--primary-light);
        }

        .mobile-post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-visibility-select {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .mobile-post-btn {
            background: var(--accent-green);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mobile-post-btn:hover {
            background: #45a372;
        }

        .mobile-post-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .mobile-social-posts {
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
        }

        .mobile-post-card {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .mobile-post-card:last-child {
            border-bottom: none;
        }

        .mobile-post-header-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .mobile-avatar-medium {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
        }

        .mobile-post-author-info {
            flex: 1;
        }

        .mobile-post-author-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.2rem;
        }

        .mobile-post-meta {
            font-size: 0.85rem;
            color: #666;
        }

        .mobile-post-content {
            margin-bottom: 0.75rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .mobile-post-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            max-height: 400px;
            object-fit: cover;
        }

        .mobile-post-engagement {
            display: flex;
            gap: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
        }

        .mobile-action-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 0.95rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mobile-action-btn:hover {
            background: #f5f5f5;
        }

        .mobile-action-btn.liked {
            color: #e74c3c;
        }

        .mobile-action-btn i {
            font-size: 1.1rem;
        }

        .mobile-empty-state {
            text-align: center;
            padding: 2rem;
            color: #999;
        }

        .mobile-empty-state i {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        /* Hide main feed daily check-in on mobile to avoid duplication */
        .main-feed {
            margin-top: 1rem;
        }
    }

    @media (max-width: 768px) {
        .quick-stats {
            grid-template-columns: 1fr;
        }

        .quick-actions {
            grid-template-columns: 1fr;
        }

        .mood-selector {
            justify-content: center;
        }

        .activity-header {
            flex-wrap: wrap;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Updated dashboard header section with Daily Check-in button and emojis removed -->
<div class="page-header dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-12">
                <h1>Welcome back, {{ user.get_full_name|default:user.username }}!</h1>
                <p class="lead">
                    {% if user.get_days_sober > 0 %}
                    {{ user.get_days_sober }} days strong in your recovery journey
                    {% else %}
                    Your recovery journey starts here
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Upgrade Prompt for Free Users -->
    {% if is_free_user %}
    {% include 'accounts/components/upgrade_prompt.html' with prompt_title="Unlock Your Full Recovery Journey" prompt_message="Get unlimited access to all features and support your recovery with Premium membership." %}
    {% endif %}

    <div class="dashboard-grid">
        <!-- Main Activity Feed -->
        <div class="main-feed">
            <div class="feed-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3><i class="fas fa-stream"></i> Community Activity</h3>
                    <div class="d-flex gap-2">
                        <a href="{% url 'accounts:community' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-users"></i> Browse Community
                        </a>
                        <a href="{% url 'blog:post_create' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-pen"></i> Share Story
                        </a>
                    </div>
                </div>
            </div>

            <!-- Daily Check-in Form -->
            <div class="checkin-form">
                <h4><i class="fas fa-heart"></i> How are you feeling today?</h4>
                <form method="post" action="{% url 'accounts:daily_checkin' %}">
                    {% csrf_token %}
                    <div class="mood-selector">
                        <label class="mood-option">
                            <input type="radio" name="mood" value="great" style="display: none;">
                            <i class="fas fa-smile-beam" style="color: #52b788;"></i> Great
                        </label>
                        <label class="mood-option">
                            <input type="radio" name="mood" value="good" style="display: none;">
                            <i class="fas fa-smile" style="color: #6ab04c;"></i> Good
                        </label>
                        <label class="mood-option">
                            <input type="radio" name="mood" value="okay" style="display: none;">
                            <i class="fas fa-meh" style="color: #f39c12;"></i> Okay
                        </label>
                        <label class="mood-option">
                            <input type="radio" name="mood" value="struggling" style="display: none;">
                            <i class="fas fa-frown" style="color: #e67e22;"></i> Struggling
                        </label>
                        <label class="mood-option">
                            <input type="radio" name="mood" value="difficult" style="display: none;">
                            <i class="fas fa-sad-tear" style="color: #e74c3c;"></i> Difficult
                        </label>
                    </div>
                    <textarea name="gratitude" placeholder="What are you grateful for today?" class="form-control mb-2"
                        rows="2"></textarea>
                    <textarea name="challenge" placeholder="What's your biggest challenge today?"
                        class="form-control mb-2" rows="2"></textarea>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-share-alt"></i> Share Check-in
                        </button>
                        <label class="form-check-label">
                            <input type="checkbox" name="is_shared" class="form-check-input">
                            Share with community
                        </label>
                    </div>
                </form>
            </div>

            <!-- Activity Feed -->
            <div class="activity-feed">
                {% for activity in recent_activities %}
                <div class="activity-item">
                    <div class="activity-header">
                        <div class="activity-avatar">
                            {% if activity.user.avatar %}
                            <img src="{{ activity.user.avatar.url }}" alt="{{ activity.user.username }}">
                            {% else %}
                            <i class="fas fa-user"></i>
                            {% endif %}
                        </div>
                        <div class="activity-content">
                            <div class="activity-user">
                                <a href="{% url 'accounts:profile' activity.user.username %}"
                                    style="text-decoration: none; color: inherit;">
                                    {{ activity.user.get_full_name|default:activity.user.username }}
                                </a>
                            </div>
                            <div class="activity-time">{{ activity.created_at|timesince }} ago</div>
                        </div>
                        {% if activity.activity_type == 'milestone_created' %}
                        <div class="activity-type-icon" style="background: #fff3cd; color: #856404;">
                            <i class="fas fa-trophy"></i>
                        </div>
                        {% elif activity.activity_type == 'blog_post_published' %}
                        <div class="activity-type-icon" style="background: #d1ecf1; color: #0c5460;">
                            <i class="fas fa-newspaper"></i>
                        </div>
                        {% elif activity.activity_type == 'check_in_posted' %}
                        <div class="activity-type-icon" style="background: #d4edda; color: #155724;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        {% endif %}
                    </div>

                    <div class="activity-description">
                        <strong>{{ activity.title }}</strong>
                        {% if activity.description %}
                        <p style="margin: 0.5rem 0 0 0; color: #666;">{{ activity.description }}</p>
                        {% endif %}
                    </div>

                    <div class="activity-engagement">
                        <button class="engagement-btn" onclick="likeActivity({{ activity.id }})" title="Like">
                            <i class="fas fa-heart"></i>
                            <span class="engagement-count">{{ activity.likes_count }}</span>
                        </button>
                        <button class="engagement-btn" onclick="toggleComments({{ activity.id }})" title="Comment">
                            <i class="fas fa-comment"></i>
                            <span class="engagement-count">{{ activity.comments.count }}</span>
                        </button>
                        <button class="engagement-btn" title="Share">
                            <i class="fas fa-share"></i>
                        </button>
                    </div>

                    <!-- Comments Section -->
                    <div id="comments-{{ activity.id }}"
                        style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f0f0f0;">
                        {% for comment in activity.comments.all|slice:":3" %}
                        <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
                            <strong>{{ comment.user.get_full_name|default:comment.user.username }}</strong>
                            <span style="color: #666; font-size: 0.85rem;">{{ comment.created_at|timesince }} ago</span>
                            <p style="margin: 0.25rem 0 0 0;">{{ comment.content }}</p>
                        </div>
                        {% endfor %}

                        <form onsubmit="submitComment(event, {{ activity.id }})" style="margin-top: 1rem;">
                            <div class="d-flex gap-2">
                                <input type="text" placeholder="Write a supportive comment..." class="form-control"
                                    required>
                                <button type="submit" class="btn btn-primary btn-sm">Post</button>
                            </div>
                        </form>
                    </div>
                </div>
                {% empty %}
                <div class="empty-feed">
                    <div class="empty-feed-icon"><i class="fas fa-seedling"></i></div>
                    <h4>Your community feed is growing!</h4>
                    <p>Follow other members to see their recovery updates and milestones here.</p>
                    <a href="{% url 'accounts:community' %}" class="btn btn-primary">
                        <i class="fas fa-users"></i> Discover Community
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- PWA Install Card -->
            {% include 'accounts/dashboard_install_card.html' %}

            <!-- Quick Stats -->
            <div class="sidebar-section">
                <h3><i class="fas fa-chart-line"></i> Your Progress</h3>
                <div class="quick-stats">
                    <div class="stat-item">
                        <div class="stat-number">{{ user.get_days_sober }}</div>
                        <div class="stat-label">Days Sober</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ user.followers_count }}</div>
                        <div class="stat-label">Followers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ user.following_count }}</div>
                        <div class="stat-label">Following</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ user.get_joined_groups.count }}</div>
                        <div class="stat-label">Groups</div>
                    </div>
                </div>
            </div>

            <!-- Recovery Connections -->
            <div class="sidebar-section">
                <h3><i class="fas fa-user-friends"></i> Your Network</h3>

                {% if user.get_active_sponsor %}
                <div class="connection-item">
                    <div class="connection-avatar">
                        {% if user.get_active_sponsor.avatar %}
                        <img src="{{ user.get_active_sponsor.avatar.url }}" alt="Sponsor">
                        {% else %}
                        <i class="fas fa-star"></i>
                        {% endif %}
                    </div>
                    <div class="connection-info">
                        <div class="connection-name">{{
                            user.get_active_sponsor.get_full_name|default:user.get_active_sponsor.username }}</div>
                        <div class="connection-status">Your Sponsor</div>
                    </div>
                </div>
                {% endif %}

                {% if user.get_recovery_pal %}
                <div class="connection-item">
                    <div class="connection-avatar">
                        {% if user.get_recovery_pal.avatar %}
                        <img src="{{ user.get_recovery_pal.avatar.url }}" alt="Pal">
                        {% else %}
                        <i class="fas fa-handshake"></i>
                        {% endif %}
                    </div>
                    <div class="connection-info">
                        <div class="connection-name">{{
                            user.get_recovery_pal.get_full_name|default:user.get_recovery_pal.username }}</div>
                        <div class="connection-status">Recovery Pal</div>
                    </div>
                </div>
                {% endif %}

                {% if user.get_active_sponsorships %}
                <h5 style="margin: 1rem 0 0.5rem 0; font-size: 0.9rem; color: #666;">Your Sponsees</h5>
                {% for sponsorship in user.get_active_sponsorships|slice:":3" %}
                <div class="connection-item">
                    <div class="connection-avatar">
                        {% if sponsorship.sponsee.avatar %}
                        <img src="{{ sponsorship.sponsee.avatar.url }}" alt="Sponsee">
                        {% else %}
                        <i class="fas fa-user"></i>
                        {% endif %}
                    </div>
                    <div class="connection-info">
                        <div class="connection-name">{{
                            sponsorship.sponsee.get_full_name|default:sponsorship.sponsee.username }}</div>
                        <div class="connection-status">Sponsee</div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}

                <div class="quick-actions">
                    <a href="{% url 'accounts:sponsor_dashboard' %}" class="action-btn">
                        <i class="fas fa-star"></i> Sponsors
                    </a>
                    <a href="{% url 'accounts:pal_dashboard' %}" class="action-btn">
                        <i class="fas fa-handshake"></i> Pals
                    </a>
                    <a href="{% url 'accounts:following_list' user.username %}" class="action-btn">
                        <i class="fas fa-user-plus"></i> Following
                    </a>
                    <a href="{% url 'accounts:followers_list' user.username %}" class="action-btn">
                        <i class="fas fa-users"></i> Followers
                    </a>
                </div>
            </div>

            <!-- Suggested Connections -->
            {% if suggested_users %}
            <div class="sidebar-section">
                <h3><i class="fas fa-user-plus"></i> Suggested for You</h3>
                {% for suggested_user in suggested_users|slice:":2" %}
                <div class="suggested-connection">
                    <div class="suggestion-avatar">
                        {% if suggested_user.avatar %}
                        <img src="{{ suggested_user.avatar.url }}" alt="{{ suggested_user.username }}">
                        {% else %}
                        <i class="fas fa-user"></i>
                        {% endif %}
                    </div>
                    <div class="suggestion-info">
                        <div class="suggestion-name">{{ suggested_user.get_full_name|default:suggested_user.username }}
                        </div>
                        <div class="suggestion-reason">Similar interests</div>
                    </div>
                    <button class="follow-suggestion-btn" onclick="followUser('{{ suggested_user.username }}')">
                        Follow
                    </button>
                </div>
                {% endfor %}
                <a href="{% url 'accounts:suggested_users' %}" class="btn btn-outline-primary btn-sm w-100">
                    See More Suggestions
                </a>
            </div>
            {% endif %}

            <!-- Recent Milestones -->
            <div class="sidebar-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><i class="fas fa-trophy"></i> Recent Milestones</h3>
                    <a href="{% url 'accounts:add_milestone' %}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-plus"></i> Add
                    </a>
                </div>
                {% for milestone in recent_milestones|slice:":3" %}
                <div class="milestone-item">
                    <div class="milestone-title">{{ milestone.title }}</div>
                    <div class="milestone-date">{{ milestone.date_achieved|date:"M j, Y" }}</div>
                </div>
                {% empty %}
                <p class="text-muted">No milestones yet. <a href="{% url 'accounts:add_milestone' %}">Add your first
                        one!</a></p>
                {% endfor %}
            </div>

            <!-- My Groups -->
            {% if user.get_joined_groups %}
            <div class="sidebar-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><i class="fas fa-users"></i> My Groups</h3>
                    <a href="{% url 'accounts:my_groups' %}" class="btn btn-outline-primary btn-sm">All</a>
                </div>
                {% for group in user.get_joined_groups|slice:":3" %}
                <a href="{% url 'accounts:group_detail' group.id %}" class="group-item">
                    <div class="group-icon" style="background: {{ group.group_color }};">
                        {% if group.group_type == 'addiction_type' %}
                        <i class="fas fa-bullseye"></i>
                        {% elif group.group_type == 'location' %}
                        <i class="fas fa-map-marker-alt"></i>
                        {% elif group.group_type == 'recovery_stage' %}
                        <i class="fas fa-star"></i>
                        {% else %}
                        <i class="fas fa-users"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <div style="font-weight: 500;">{{ group.name }}</div>
                        <div style="font-size: 0.8rem; color: #666;">{{ group.member_count }} members</div>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="sidebar-section">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                <div class="quick-actions" style="grid-template-columns: 1fr;">
                    <a href="{% url 'accounts:edit_profile' %}" class="action-btn">
                        <i class="fas fa-user-edit"></i> Edit Profile
                    </a>
                    <a href="{% url 'accounts:messages' %}" class="action-btn">
                        <i class="fas fa-envelope"></i> Messages
                        {% if unread_messages > 0 %}
                        <span
                            style="background: red; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">{{
                            unread_messages }}</span>
                        {% endif %}
                    </a>
                    <a href="{% url 'journal:dashboard' %}" class="action-btn">
                        <i class="fas fa-book"></i> Journal
                    </a>
                    <a href="{% url 'blog:post_list' %}" class="action-btn">
                        <i class="fas fa-newspaper"></i> Read Blog
                    </a>
                    <a href="{% url 'resources:list' %}" class="action-btn">
                        <i class="fas fa-book-open"></i> Resources
                    </a>
                    <a href="{% url 'accounts:groups_list' %}" class="action-btn">
                        <i class="fas fa-plus-circle"></i> Create Group
                    </a>
                </div>
            </div>
        </div>

        <!-- Mobile Social Feed Section -->
        <div class="mobile-social-feed">
            <div class="mobile-feed-header">
                <h3><i class="fas fa-fire"></i> Community Feed</h3>
                <a href="{% url 'accounts:social_feed' %}" class="btn btn-sm btn-outline-primary">
                    View All
                </a>
            </div>

            <!-- Create Post Box for Mobile -->
            <div class="mobile-create-post">
                <div class="mobile-post-header">
                    {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="{{ user.username }}" class="mobile-avatar-small">
                    {% else %}
                        <img src="{% static 'images/default-avatar.png' %}" alt="{{ user.username }}" class="mobile-avatar-small">
                    {% endif %}
                    <span>Share with the community...</span>
                </div>
                <form id="mobile-create-post-form" enctype="multipart/form-data">
                    {% csrf_token %}
                    <textarea
                        class="mobile-post-textarea"
                        name="content"
                        id="mobile-post-content"
                        placeholder="Share your journey, wins, or encouragement..."
                        maxlength="1000"
                    ></textarea>

                    <!-- Image Preview -->
                    <div id="mobile-image-preview-container" style="display: none; padding: 0.5rem; margin-top: 0.5rem;">
                        <div style="position: relative; display: inline-block;">
                            <img id="mobile-image-preview" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                            <button type="button" id="mobile-remove-image-btn" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mobile-post-actions">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="file" name="image" id="mobile-post-image-input" accept="image/*" style="display: none;">
                            <button type="button" id="mobile-add-photo-btn" class="action-btn" style="padding: 0.5rem; margin: 0; background: none; border: 1px solid #ddd; border-radius: 8px; color: #52b788;" title="Add Photo">
                                <i class="fas fa-image"></i>
                            </button>
                            <select name="visibility" class="mobile-visibility-select">
                                <option value="public">üåç Everyone</option>
                                <option value="friends">üë• Friends</option>
                                <option value="private">üîí Only Me</option>
                            </select>
                        </div>
                        <button type="submit" class="mobile-post-btn" id="mobile-post-submit-btn" disabled>Post</button>
                    </div>
                </form>
            </div>

            <!-- Mobile Social Posts -->
            <div class="mobile-social-posts">
                {% if social_posts %}
                    {% for post in social_posts|slice:":5" %}
                    <div class="mobile-post-card" data-post-id="{{ post.id }}">
                        <div class="mobile-post-header-info">
                            {% if post.author.avatar %}
                                <img src="{{ post.author.avatar.url }}" alt="{{ post.author.username }}" class="mobile-avatar-medium">
                            {% else %}
                                <img src="{% static 'images/default-avatar.png' %}" alt="{{ post.author.username }}" class="mobile-avatar-medium">
                            {% endif %}
                            <div class="mobile-post-author-info">
                                <div class="mobile-post-author-name">{{ post.author.get_full_name|default:post.author.username }}</div>
                                <div class="mobile-post-meta">{{ post.created_at|timesince }} ago</div>
                            </div>
                        </div>
                        <div class="mobile-post-content">{{ post.content }}</div>
                        {% if post.image %}
                        <img src="{{ post.image.url }}" alt="Post image" class="mobile-post-image">
                        {% endif %}
                        <div class="mobile-post-engagement">
                            <button class="mobile-action-btn mobile-like-btn {% if user in post.likes.all %}liked{% endif %}" data-post-id="{{ post.id }}">
                                <i class="{% if user in post.likes.all %}fas{% else %}far{% endif %} fa-heart"></i>
                                <span>{{ post.likes.count }}</span>
                            </button>
                            <button class="mobile-action-btn" onclick="window.location.href='{% url 'accounts:social_feed' %}'">
                                <i class="far fa-comment"></i>
                                <span>{{ post.comments.count }}</span>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="mobile-empty-state">
                        <i class="fas fa-comments"></i>
                        <p>Be the first to share!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Mood selector functionality
    document.querySelectorAll('.mood-option').forEach(option => {
        option.addEventListener('click', function () {
            document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            this.querySelector('input').checked = true;
        });
    });

    // Activity interactions
    async function likeActivity(activityId) {
        try {
            const response = await fetch(`/accounts/like-activity/${activityId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            });

            const data = await response.json();
            if (data.success) {
                // Update like count and button state
                location.reload(); // Simple reload for now
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function toggleComments(activityId) {
        const commentsDiv = document.getElementById(`comments-${activityId}`);
        commentsDiv.style.display = commentsDiv.style.display === 'none' ? 'block' : 'none';
    }

    async function submitComment(event, activityId) {
        event.preventDefault();
        const form = event.target;
        const input = form.querySelector('input');

        try {
            const response = await fetch(`/accounts/comment-on-activity/${activityId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `comment=${encodeURIComponent(input.value)}`
            });

            const data = await response.json();
            if (data.success) {
                input.value = '';
                location.reload(); // Simple reload for now
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function followUser(username) {
        try {
            const response = await fetch(`/accounts/follow/${username}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            });

            const data = await response.json();
            if (data.success) {
                showToast(data.is_following ? 'Now following!' : 'Unfollowed', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible`;
        toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(toast);

        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }

    // Add CSRF token if not present
    document.addEventListener('DOMContentLoaded', function () {
        if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
            const token = document.createElement('input');
            token.type = 'hidden';
            token.name = 'csrfmiddlewaretoken';
            token.value = '{{ csrf_token }}';
            document.body.appendChild(token);
        }
    });

    // Mobile Social Feed JavaScript
    const mobileTextarea = document.getElementById('mobile-post-content');
    const mobileSubmitBtn = document.getElementById('mobile-post-submit-btn');
    const mobileAddPhotoBtn = document.getElementById('mobile-add-photo-btn');
    const mobileImageInput = document.getElementById('mobile-post-image-input');
    const mobileImagePreviewContainer = document.getElementById('mobile-image-preview-container');
    const mobileImagePreview = document.getElementById('mobile-image-preview');
    const mobileRemoveImageBtn = document.getElementById('mobile-remove-image-btn');

    if (mobileTextarea && mobileSubmitBtn) {
        mobileTextarea.addEventListener('input', function() {
            const hasImage = mobileImageInput && mobileImageInput.files.length > 0;
            mobileSubmitBtn.disabled = this.value.trim().length === 0 && !hasImage;
        });

        // Photo button click handler
        if (mobileAddPhotoBtn && mobileImageInput) {
            mobileAddPhotoBtn.addEventListener('click', function() {
                mobileImageInput.click();
            });

            // Image input change handler
            mobileImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file');
                        this.value = '';
                        return;
                    }

                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Image size must be less than 5MB');
                        this.value = '';
                        return;
                    }

                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        mobileImagePreview.src = e.target.result;
                        mobileImagePreviewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);

                    // Enable submit button if image is selected
                    mobileSubmitBtn.disabled = false;
                }
            });

            // Remove image button handler
            if (mobileRemoveImageBtn) {
                mobileRemoveImageBtn.addEventListener('click', function() {
                    mobileImageInput.value = '';
                    mobileImagePreviewContainer.style.display = 'none';
                    mobileImagePreview.src = '';

                    // Disable submit button if no content
                    const hasContent = mobileTextarea.value.trim().length > 0;
                    mobileSubmitBtn.disabled = !hasContent;
                });
            }
        }

        // Mobile create post form submission
        const mobileCreatePostForm = document.getElementById('mobile-create-post-form');
        if (mobileCreatePostForm) {
            mobileCreatePostForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                mobileSubmitBtn.disabled = true;
                mobileSubmitBtn.textContent = 'Posting...';

                try {
                    const response = await fetch('{% url "accounts:create_social_post" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Reload page to show new post
                        window.location.reload();
                    } else {
                        alert(data.error || 'Failed to create post');
                        mobileSubmitBtn.disabled = false;
                        mobileSubmitBtn.textContent = 'Post';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to create post');
                    mobileSubmitBtn.disabled = false;
                    mobileSubmitBtn.textContent = 'Post';
                }
            });
        }
    }

    // Mobile like button handlers
    document.querySelectorAll('.mobile-like-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const postId = this.dataset.postId;

            try {
                const response = await fetch(`/accounts/social-feed/post/${postId}/like/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const icon = this.querySelector('i');
                    const count = this.querySelector('span');

                    if (data.liked) {
                        this.classList.add('liked');
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                    } else {
                        this.classList.remove('liked');
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                    }

                    count.textContent = data.likes_count;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}