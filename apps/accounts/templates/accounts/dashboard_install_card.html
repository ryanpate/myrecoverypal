<!-- PWA Install Card - Insert this at the top of the sidebar in dashboard.html -->
<div class="sidebar-section" id="pwa-install-card" style="background: linear-gradient(135deg, #1e4d8b 0%, #4db8e8 60%, #52b788 100%); color: white; display: none;">
    <button onclick="dismissInstallCard()" style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem;">&times;</button>

    <div style="text-align: center;">
        <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: rgba(255,255,255,0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-mobile-alt" style="font-size: 2.5rem;"></i>
        </div>

        <h3 style="color: white; margin-bottom: 0.5rem;"><i class="fas fa-download"></i> Get the App!</h3>
        <p style="margin-bottom: 1.5rem; font-size: 0.95rem; opacity: 0.95;">Install MyRecoveryPal for quick access and offline support</p>

        <button id="dashboardInstallBtn" class="btn btn-light btn-sm" style="padding: 0.6rem 1.5rem; font-weight: 600; width: 100%; margin-bottom: 0.75rem;">
            <i class="fas fa-download"></i> Install Now
        </button>

        <a href="{% url 'core:install_guide' %}" style="color: rgba(255,255,255,0.9); font-size: 0.85rem; text-decoration: underline;">
            View install instructions
        </a>
    </div>
</div>

<style>
    #pwa-install-card {
        position: relative;
    }

    @media (max-width: 768px) {
        #pwa-install-card {
            order: -2;
        }
    }
</style>

<script>
    // PWA Install Card Logic with iOS and Firefox Support
    (function() {
        const installCard = document.getElementById('pwa-install-card');
        const installBtn = document.getElementById('dashboardInstallBtn');
        let deferredPrompt;

        // Detect browser and platform
        const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
        const isFirefoxAndroid = isFirefox && /Android/i.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

        // Check if already dismissed
        if (localStorage.getItem('pwa-install-dismissed') === 'true') {
            return;
        }

        // Check if already installed
        if (isStandalone) {
            return;
        }

        // Show card for iOS users with special messaging
        if (isIOS) {
            const cardContent = installCard.querySelector('div[style*="text-align: center"]');
            cardContent.innerHTML = `
                <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: rgba(255,255,255,0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                    <i class="fab fa-apple" style="font-size: 2.5rem;"></i>
                </div>
                <h3 style="color: white; margin-bottom: 0.5rem;"><i class="fas fa-download"></i> Install on iPhone</h3>
                <p style="margin-bottom: 1.5rem; font-size: 0.95rem; opacity: 0.95;">
                    Tap <i class="fas fa-share" style="margin: 0 4px;"></i> then "Add to Home Screen"
                </p>
                <a href="{% url 'core:install_guide' %}" class="btn btn-light btn-sm" style="padding: 0.6rem 1.5rem; font-weight: 600; width: 100%; margin-bottom: 0.75rem; text-decoration: none; display: inline-block;">
                    <i class="fas fa-info-circle"></i> Show Me How
                </a>
                <button onclick="dismissInstallCard()" style="background: none; border: none; color: rgba(255,255,255,0.9); font-size: 0.85rem; text-decoration: underline; cursor: pointer; padding: 0;">
                    Maybe Later
                </button>
            `;
            installCard.style.display = 'block';
            return; // Exit early for iOS
        }

        // Show card for Firefox users with special messaging
        if (isFirefox) {
            const cardContent = installCard.querySelector('div[style*="text-align: center"]');
            if (isFirefoxAndroid) {
                // Firefox Android supports PWA installation
                cardContent.innerHTML = `
                    <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: rgba(255,255,255,0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fab fa-firefox-browser" style="font-size: 2.5rem;"></i>
                    </div>
                    <h3 style="color: white; margin-bottom: 0.5rem;"><i class="fas fa-download"></i> Install the App</h3>
                    <p style="margin-bottom: 1.5rem; font-size: 0.95rem; opacity: 0.95;">
                        Tap menu <i class="fas fa-ellipsis-v" style="margin: 0 4px;"></i> then "Install"
                    </p>
                    <a href="{% url 'core:install_guide' %}" class="btn btn-light btn-sm" style="padding: 0.6rem 1.5rem; font-weight: 600; width: 100%; margin-bottom: 0.75rem; text-decoration: none; display: inline-block;">
                        <i class="fas fa-info-circle"></i> Show Me How
                    </a>
                    <button onclick="dismissInstallCard()" style="background: none; border: none; color: rgba(255,255,255,0.9); font-size: 0.85rem; text-decoration: underline; cursor: pointer; padding: 0;">
                        Maybe Later
                    </button>
                `;
            } else {
                // Firefox Desktop has limited PWA support
                cardContent.innerHTML = `
                    <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: rgba(255,255,255,0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fab fa-firefox-browser" style="font-size: 2.5rem;"></i>
                    </div>
                    <h3 style="color: white; margin-bottom: 0.5rem;"><i class="fas fa-download"></i> Get the App</h3>
                    <p style="margin-bottom: 1.5rem; font-size: 0.95rem; opacity: 0.95;">
                        For best PWA experience, use Chrome, Edge, or Safari
                    </p>
                    <a href="{% url 'core:install_guide' %}" class="btn btn-light btn-sm" style="padding: 0.6rem 1.5rem; font-weight: 600; width: 100%; margin-bottom: 0.75rem; text-decoration: none; display: inline-block;">
                        <i class="fas fa-info-circle"></i> Learn More
                    </a>
                    <button onclick="dismissInstallCard()" style="background: none; border: none; color: rgba(255,255,255,0.9); font-size: 0.85rem; text-decoration: underline; cursor: pointer; padding: 0;">
                        Maybe Later
                    </button>
                `;
            }
            installCard.style.display = 'block';
            return; // Exit early for Firefox
        }

        // Show card when install prompt is available (Chrome/Edge/Android)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installCard.style.display = 'block';
        });

        // Install button click
        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;

                    if (outcome === 'accepted') {
                        installCard.style.display = 'none';
                        localStorage.setItem('pwa-install-dismissed', 'true');
                    }

                    deferredPrompt = null;
                } else {
                    // Redirect to install page
                    window.location.href = '{% url "core:install_guide" %}';
                }
            });
        }

        // Hide on successful install
        window.addEventListener('appinstalled', () => {
            installCard.style.display = 'none';
            localStorage.setItem('pwa-install-dismissed', 'true');
        });
    })();

    function dismissInstallCard() {
        document.getElementById('pwa-install-card').style.display = 'none';
        localStorage.setItem('pwa-install-dismissed', 'true');
    }
</script>
