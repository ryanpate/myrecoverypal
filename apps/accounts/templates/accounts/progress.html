{% extends 'base.html' %}
{% load static %}

{% block title %}My Progress - MyRecoveryPal{% endblock %}

{% block extra_css %}
<style>
    .progress-container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .progress-header {
        background: linear-gradient(135deg, #1e4d8b 0%, #4db8e8 100%);
        color: white;
        padding: 2rem;
        border-radius: 20px;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .progress-header h1 {
        color: white;
        margin: 0 0 0.5rem;
        font-size: 1.75rem;
    }

    .progress-header p {
        margin: 0;
        opacity: 0.9;
    }

    .time-selector {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }

    .time-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 0.5rem 1.25rem;
        border-radius: 20px;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s;
    }

    .time-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    .time-btn.active {
        background: white;
        color: #1e4d8b;
    }

    /* Milestone Progress Card */
    .milestone-card {
        background: linear-gradient(135deg, #52b788 0%, #40916c 100%);
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 40px rgba(82, 183, 136, 0.2);
    }

    .milestone-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .milestone-days {
        font-size: 2.5rem;
        font-weight: 700;
    }

    .milestone-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .milestone-next {
        text-align: right;
    }

    .milestone-next-label {
        font-size: 0.85rem;
        opacity: 0.8;
    }

    .milestone-next-days {
        font-size: 1.5rem;
        font-weight: 600;
    }

    .milestone-progress-bar {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        height: 12px;
        overflow: hidden;
    }

    .milestone-progress-fill {
        background: white;
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .milestone-progress-text {
        text-align: center;
        margin-top: 0.75rem;
        font-size: 0.9rem;
        opacity: 0.9;
    }

    /* Weekly Comparison */
    .weekly-comparison {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
        align-items: center;
    }

    .week-card {
        background: white;
        border-radius: 15px;
        padding: 1.25rem;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .week-label {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.5rem;
    }

    .week-mood {
        font-size: 1.75rem;
        font-weight: 700;
        color: #52b788;
    }

    .week-details {
        font-size: 0.8rem;
        color: #999;
        margin-top: 0.25rem;
    }

    .week-change {
        text-align: center;
    }

    .change-arrow {
        font-size: 2rem;
    }

    .change-arrow.up { color: #52b788; }
    .change-arrow.down { color: #ff6b6b; }
    .change-arrow.same { color: #999; }

    .change-percent {
        font-size: 0.9rem;
        font-weight: 600;
    }

    .change-percent.positive { color: #52b788; }
    .change-percent.negative { color: #ff6b6b; }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] .stat-card,
    [data-theme="dark"] .week-card,
    [data-theme="dark"] .chart-card,
    [data-theme="dark"] .insight-card {
        background: var(--card-bg);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1e4d8b;
    }

    .stat-value.mood { color: #52b788; }
    .stat-value.craving { color: #ff6b6b; }
    .stat-value.energy { color: #4db8e8; }
    .stat-value.streak { color: #ffa502; }

    .stat-label {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.5rem;
    }

    /* Chart Cards */
    .chart-card {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    [data-theme="dark"] .chart-title {
        color: var(--text-primary);
    }

    .chart-container {
        position: relative;
        height: 250px;
    }

    .chart-container-small {
        position: relative;
        height: 200px;
    }

    .secondary-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    /* Calendar Heatmap */
    .heatmap-container {
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }

    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(13, 1fr);
        gap: 3px;
        min-width: 500px;
    }

    .heatmap-month {
        font-size: 0.7rem;
        color: #999;
        text-align: center;
        padding-bottom: 0.25rem;
    }

    .heatmap-week {
        display: grid;
        grid-template-rows: repeat(7, 1fr);
        gap: 3px;
    }

    .heatmap-day {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        background: #eee;
    }

    [data-theme="dark"] .heatmap-day {
        background: #333;
    }

    .heatmap-day.level-1 { background: #fef3c7; }
    .heatmap-day.level-2 { background: #fcd34d; }
    .heatmap-day.level-3 { background: #a3e635; }
    .heatmap-day.level-4 { background: #4ade80; }
    .heatmap-day.level-5 { background: #22c55e; }
    .heatmap-day.level-6 { background: #16a34a; }

    .heatmap-legend {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1rem;
        font-size: 0.75rem;
        color: #666;
    }

    .heatmap-legend-item {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }

    /* Insights */
    .insight-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    [data-theme="dark"] .insight-card {
        background: linear-gradient(135deg, #2a2a2a 0%, #333 100%);
    }

    .insight-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    [data-theme="dark"] .insight-title {
        color: var(--text-primary);
    }

    .insight-text {
        color: #666;
        font-size: 0.95rem;
    }

    [data-theme="dark"] .insight-text {
        color: var(--text-secondary);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] .empty-state {
        background: var(--card-bg);
    }

    .empty-state i {
        font-size: 4rem;
        color: #ddd;
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        color: #666;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #999;
        margin-bottom: 1.5rem;
    }

    .btn-checkin {
        background: linear-gradient(135deg, #52b788 0%, #40916c 100%);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
    }

    .btn-checkin:hover {
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(82, 183, 136, 0.3);
    }

    @media (max-width: 768px) {
        .weekly-comparison {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .week-change {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .change-arrow {
            font-size: 1.5rem;
            transform: rotate(90deg);
        }
    }

    @media (max-width: 576px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .chart-container {
            height: 200px;
        }

        .secondary-charts {
            grid-template-columns: 1fr;
        }

        .milestone-header {
            flex-direction: column;
            text-align: center;
            gap: 1rem;
        }

        .milestone-next {
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="progress-container">
    <!-- Header -->
    <div class="progress-header">
        <h1><i class="fas fa-chart-line"></i> My Progress</h1>
        <p>Track your mood, cravings, and energy over time</p>

        <div class="time-selector">
            <a href="?days=7" class="time-btn {% if days == 7 %}active{% endif %}">7 Days</a>
            <a href="?days=30" class="time-btn {% if days == 30 %}active{% endif %}">30 Days</a>
            <a href="?days=90" class="time-btn {% if days == 90 %}active{% endif %}">90 Days</a>
        </div>
    </div>

    {% if days_sober %}
    <!-- Milestone Progress -->
    <div class="milestone-card">
        <div class="milestone-header">
            <div>
                <div class="milestone-days">{{ days_sober }}</div>
                <div class="milestone-label">Days Sober</div>
            </div>
            <div class="milestone-next">
                <div class="milestone-next-label">Next Milestone</div>
                <div class="milestone-next-days">{{ next_milestone }} days</div>
            </div>
        </div>
        <div class="milestone-progress-bar">
            <div class="milestone-progress-fill" style="width: {{ milestone_progress }}%"></div>
        </div>
        <div class="milestone-progress-text">
            {% if days_to_milestone > 0 %}
            {{ days_to_milestone }} days until your next milestone
            {% else %}
            You've reached {{ next_milestone }} days! Amazing!
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if total_checkins > 0 %}
    <!-- Weekly Comparison -->
    {% if weekly_comparison.last_week.count > 0 %}
    <div class="weekly-comparison">
        <div class="week-card">
            <div class="week-label">Last Week</div>
            <div class="week-mood">{{ weekly_comparison.last_week.avg_mood }}</div>
            <div class="week-details">{{ weekly_comparison.last_week.count }} check-ins</div>
        </div>
        <div class="week-change">
            {% if weekly_comparison.mood_change > 0 %}
            <div class="change-arrow up"><i class="fas fa-arrow-up"></i></div>
            <div class="change-percent positive">+{{ weekly_comparison.mood_change }}%</div>
            {% elif weekly_comparison.mood_change < 0 %}
            <div class="change-arrow down"><i class="fas fa-arrow-down"></i></div>
            <div class="change-percent negative">{{ weekly_comparison.mood_change }}%</div>
            {% else %}
            <div class="change-arrow same"><i class="fas fa-equals"></i></div>
            <div class="change-percent">No change</div>
            {% endif %}
        </div>
        <div class="week-card">
            <div class="week-label">This Week</div>
            <div class="week-mood">{{ weekly_comparison.this_week.avg_mood }}</div>
            <div class="week-details">{{ weekly_comparison.this_week.count }} check-ins</div>
        </div>
    </div>
    {% endif %}

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ total_checkins }}</div>
            <div class="stat-label">Check-ins</div>
        </div>
        <div class="stat-card">
            <div class="stat-value mood">{{ avg_mood }} {{ avg_mood_emoji }}</div>
            <div class="stat-label">Avg Mood</div>
        </div>
        <div class="stat-card">
            <div class="stat-value streak">{{ current_streak }}</div>
            <div class="stat-label">Day Streak</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ checkin_rate }}%</div>
            <div class="stat-label">Check-in Rate</div>
        </div>
    </div>

    <!-- Insights -->
    {% if best_mood_checkin %}
    <div class="insight-card">
        <div class="insight-title"><i class="fas fa-lightbulb" style="color: #ffa502;"></i> Insights</div>
        <div class="insight-text">
            Your best day was <strong>{{ best_mood_checkin.date|date:"M d" }}</strong> when you felt {{ best_mood_checkin.get_mood_display }}.
            {% if zero_craving_days > 0 %}
            You had <strong>{{ zero_craving_days }} days</strong> with zero cravings!
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Main Mood Chart -->
    <div class="chart-card">
        <div class="chart-title">
            <i class="fas fa-smile" style="color: #52b788;"></i>
            Mood Trend
        </div>
        <div class="chart-container">
            <canvas id="moodChart"></canvas>
        </div>
    </div>

    <!-- Secondary Charts Row -->
    <div class="secondary-charts">
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-fire" style="color: #ff6b6b;"></i>
                Craving Levels
            </div>
            <div class="chart-container-small">
                <canvas id="cravingChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-bolt" style="color: #4db8e8;"></i>
                Energy Levels
            </div>
            <div class="chart-container-small">
                <canvas id="energyChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-chart-pie" style="color: #a855f7;"></i>
                Mood Distribution
            </div>
            <div class="chart-container-small">
                <canvas id="moodPieChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Check-in Calendar Heatmap -->
    <div class="chart-card">
        <div class="chart-title">
            <i class="fas fa-calendar-check" style="color: #22c55e;"></i>
            Check-in Calendar (Last 90 Days)
        </div>
        <div class="heatmap-container">
            <div id="heatmapGrid" class="heatmap-grid"></div>
        </div>
        <div class="heatmap-legend">
            <span>Less</span>
            <div class="heatmap-legend-item" style="background: #eee;"></div>
            <div class="heatmap-legend-item level-1" style="background: #fef3c7;"></div>
            <div class="heatmap-legend-item level-3" style="background: #a3e635;"></div>
            <div class="heatmap-legend-item level-5" style="background: #22c55e;"></div>
            <div class="heatmap-legend-item level-6" style="background: #16a34a;"></div>
            <span>Better Mood</span>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <i class="fas fa-chart-bar"></i>
        <h3>No check-ins yet</h3>
        <p>Start tracking your mood, cravings, and energy to see your progress visualized here.</p>
        <a href="{% url 'accounts:daily_checkin' %}" class="btn-checkin">
            <i class="fas fa-plus"></i> Do Your First Check-in
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if total_checkins > 0 %}
<script>
    const chartData = {{ chart_data|safe }};
    const moodDistribution = {{ mood_distribution|safe }};
    const heatmapData = {{ heatmap_data|safe }};

    // Detect dark mode
    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDarkMode ? '#e0e0e0' : '#666';
    const gridColor = isDarkMode ? '#404040' : '#e0e0e0';

    // Mood labels for Y-axis
    const moodLabels = ['', 'Struggling', 'Down', 'Okay', 'Good', 'Great', 'Amazing'];
    const cravingLabels = ['None', 'Mild', 'Moderate', 'Strong', 'Intense'];

    // Common chart options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: textColor
                }
            },
            y: {
                grid: {
                    color: gridColor
                },
                ticks: {
                    color: textColor
                }
            }
        },
        elements: {
            point: {
                radius: 4,
                hoverRadius: 6
            }
        }
    };

    // Mood Chart
    new Chart(document.getElementById('moodChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Mood',
                data: chartData.mood,
                borderColor: '#52b788',
                backgroundColor: 'rgba(82, 183, 136, 0.1)',
                tension: 0.3,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                ...commonOptions.scales,
                y: {
                    ...commonOptions.scales.y,
                    min: 1,
                    max: 6,
                    ticks: {
                        ...commonOptions.scales.y.ticks,
                        stepSize: 1,
                        callback: function(value) {
                            return moodLabels[value] || '';
                        }
                    }
                }
            },
            plugins: {
                ...commonOptions.plugins,
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Mood: ' + moodLabels[context.raw];
                        }
                    }
                }
            }
        }
    });

    // Craving Chart
    new Chart(document.getElementById('cravingChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Craving Level',
                data: chartData.craving,
                borderColor: '#ff6b6b',
                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                tension: 0.3,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                ...commonOptions.scales,
                y: {
                    ...commonOptions.scales.y,
                    min: 0,
                    max: 4,
                    ticks: {
                        ...commonOptions.scales.y.ticks,
                        stepSize: 1,
                        callback: function(value) {
                            return cravingLabels[value] || '';
                        }
                    }
                }
            },
            plugins: {
                ...commonOptions.plugins,
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Craving: ' + cravingLabels[context.raw];
                        }
                    }
                }
            }
        }
    });

    // Energy Chart
    new Chart(document.getElementById('energyChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Energy Level',
                data: chartData.energy,
                borderColor: '#4db8e8',
                backgroundColor: 'rgba(77, 184, 232, 0.1)',
                tension: 0.3,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                ...commonOptions.scales,
                y: {
                    ...commonOptions.scales.y,
                    min: 1,
                    max: 5,
                    ticks: {
                        ...commonOptions.scales.y.ticks,
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Mood Distribution Pie Chart
    const moodColors = {
        'Struggling': '#ef4444',
        'Down': '#f97316',
        'Okay': '#eab308',
        'Good': '#84cc16',
        'Great': '#22c55e',
        'Amazing': '#10b981'
    };

    const pieLabels = Object.keys(moodDistribution);
    const pieData = Object.values(moodDistribution);
    const pieColors = pieLabels.map(label => {
        // Extract mood name without emoji
        const moodName = label.split(' ').pop();
        return moodColors[moodName] || '#999';
    });

    new Chart(document.getElementById('moodPieChart'), {
        type: 'doughnut',
        data: {
            labels: pieLabels,
            datasets: [{
                data: pieData,
                backgroundColor: pieColors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: textColor,
                        padding: 10,
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });

    // Build Calendar Heatmap
    function buildHeatmap() {
        const grid = document.getElementById('heatmapGrid');
        const today = new Date();
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 90);

        // Start from the beginning of the week
        const dayOfWeek = startDate.getDay();
        startDate.setDate(startDate.getDate() - dayOfWeek);

        let currentDate = new Date(startDate);
        let currentWeek = null;
        let weekCount = 0;

        while (currentDate <= today || weekCount < 13) {
            if (currentDate.getDay() === 0) {
                // New week
                currentWeek = document.createElement('div');
                currentWeek.className = 'heatmap-week';
                grid.appendChild(currentWeek);
                weekCount++;
            }

            const dateStr = currentDate.toISOString().split('T')[0];
            const day = document.createElement('div');
            day.className = 'heatmap-day';

            if (heatmapData[dateStr]) {
                day.classList.add('level-' + heatmapData[dateStr]);
                day.title = `${currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}: ${moodLabels[heatmapData[dateStr]]}`;
            } else if (currentDate <= today) {
                day.title = `${currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}: No check-in`;
            }

            if (currentWeek) {
                currentWeek.appendChild(day);
            }

            currentDate.setDate(currentDate.getDate() + 1);

            if (weekCount >= 13 && currentDate.getDay() === 0) {
                break;
            }
        }
    }

    buildHeatmap();

    // Listen for theme changes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'data-theme') {
                // Reload page to update chart colors
                window.location.reload();
            }
        });
    });

    observer.observe(document.documentElement, { attributes: true });
</script>
{% endif %}
{% endblock %}
