{% extends 'base.html' %}
{% load static %}

{% block title %}AI Recovery Coach - MyRecoveryPal{% endblock %}

{% block extra_css %}
<style>
    /* ==============================
       RECOVERY COACH - LAYOUT
       ============================== */
    /* Override body padding â€” coach page manages its own spacing */
    body {
        padding-top: 0 !important;
    }

    .coach-page {
        display: flex;
        height: calc(100vh - max(100px, 100px + env(safe-area-inset-top)));
        margin-top: max(100px, calc(100px + env(safe-area-inset-top)));
        max-width: 100%;
        overflow: hidden;
        background: var(--bg-light);
    }

    /* ==============================
       SESSION SIDEBAR
       ============================== */
    .coach-sidebar {
        width: 280px;
        min-width: 280px;
        background: var(--bg-lighter);
        border-right: 1px solid var(--border-color, #e2e8f0);
        display: flex;
        flex-direction: column;
        z-index: 10;
    }

    .sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color, #e2e8f0);
    }

    .btn-new-session {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.75rem 1rem;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-new-session:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(30, 77, 139, 0.3);
    }

    .sidebar-sessions {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .sidebar-sessions::-webkit-scrollbar {
        width: 4px;
    }

    .sidebar-sessions::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 2px;
    }

    .session-link {
        display: block;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        text-decoration: none;
        color: var(--text-dark);
        transition: all 0.2s ease;
        margin-bottom: 2px;
        cursor: pointer;
    }

    .session-link:hover {
        background: rgba(30, 77, 139, 0.06);
        color: var(--text-dark);
        text-decoration: none;
    }

    .session-link.active {
        background: rgba(30, 77, 139, 0.1);
        color: var(--primary-dark);
        font-weight: 500;
    }

    .session-link-title {
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 2px;
    }

    .session-link-date {
        font-size: 0.75rem;
        color: #94a3b8;
    }

    .session-link.active .session-link-date {
        color: #64748b;
    }

    .sidebar-empty {
        padding: 2rem 1rem;
        text-align: center;
        color: #94a3b8;
        font-size: 0.85rem;
    }

    .sidebar-empty i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
        opacity: 0.4;
    }

    /* Mobile sidebar controls */
    .sidebar-toggle-btn {
        display: none;
        position: fixed;
        top: calc(80px + env(safe-area-inset-top, 0px));
        left: calc(10px + env(safe-area-inset-left, 0px));
        z-index: 20;
        width: 40px;
        height: 40px;
        background: var(--bg-lighter);
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 12px;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        color: var(--text-dark);
        font-size: 1.1rem;
    }

    .sidebar-backdrop {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 9;
    }

    /* ==============================
       CHAT AREA
       ============================== */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background: var(--bg-light);
    }

    /* Chat Header */
    .chat-top-bar {
        padding: 0.75rem 1.25rem;
        background: var(--bg-lighter);
        border-bottom: 1px solid var(--border-color, #e2e8f0);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .chat-top-bar-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .coach-icon {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--gradient-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .coach-info-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-dark);
        line-height: 1.2;
    }

    .coach-info-label {
        font-size: 0.8rem;
        color: #64748b;
    }

    .premium-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.15rem 0.5rem;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 6px;
    }

    .msg-counter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.85rem;
        background: rgba(30, 77, 139, 0.08);
        border-radius: 20px;
        font-size: 0.85rem;
        color: var(--primary-dark);
        font-weight: 500;
        flex-shrink: 0;
    }

    .msg-counter i {
        color: var(--primary-dark);
    }

    .msg-counter.counter-low {
        background: #fef3c7;
        color: #92400e;
    }

    .msg-counter.counter-low i {
        color: #d97706;
    }

    .msg-counter.counter-empty {
        background: #fee2e2;
        color: #991b1b;
    }

    .msg-counter.counter-empty i {
        color: #dc2626;
    }

    /* Disclaimer Banner */
    .coach-disclaimer {
        padding: 0;
        background: #fef3c7;
        border-bottom: 2px solid #f59e0b;
        flex-shrink: 0;
    }

    .disclaimer-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 1.25rem;
        cursor: pointer;
        user-select: none;
    }

    .disclaimer-bar:hover {
        background: rgba(245, 158, 11, 0.08);
    }

    .disclaimer-bar-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .disclaimer-bar-left i {
        color: #d97706;
        font-size: 0.9rem;
    }

    .disclaimer-bar-left strong {
        color: #92400e;
        font-size: 0.8rem;
    }

    .disclaimer-bar-left .disclaimer-crisis-inline {
        font-size: 0.75rem;
        color: #92400e;
        margin-left: 0.5rem;
    }

    .disclaimer-bar-left .disclaimer-crisis-inline a {
        color: #dc2626;
        font-weight: 700;
        text-decoration: underline;
    }

    .disclaimer-toggle-icon {
        color: #92400e;
        font-size: 0.75rem;
        transition: transform 0.2s ease;
        flex-shrink: 0;
    }

    .coach-disclaimer.expanded .disclaimer-toggle-icon {
        transform: rotate(180deg);
    }

    .disclaimer-details {
        display: none;
        padding: 0 1.25rem 0.75rem;
    }

    .coach-disclaimer.expanded .disclaimer-details {
        display: block;
    }

    .disclaimer-text {
        font-size: 0.78rem;
        color: #78350f;
        line-height: 1.5;
        margin: 0 0 0.4rem;
    }

    .disclaimer-text a {
        color: #92400e;
        font-weight: 700;
        text-decoration: underline;
    }

    .disclaimer-text a:hover {
        color: #78350f;
    }

    .disclaimer-crisis {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-top: 0.4rem;
        border-top: 1px solid rgba(245, 158, 11, 0.3);
        font-size: 0.8rem;
        font-weight: 600;
        color: #92400e;
    }

    .disclaimer-crisis i {
        color: #dc2626;
    }

    .disclaimer-crisis a {
        color: #dc2626;
        font-weight: 700;
        text-decoration: underline;
    }

    .disclaimer-crisis a:hover {
        color: #991b1b;
    }

    @media (max-width: 768px) {
        .disclaimer-bar-left .disclaimer-crisis-inline {
            display: none;
        }
    }

    /* ==============================
       MESSAGES
       ============================== */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        scroll-behavior: smooth;
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    /* Message Rows */
    .msg-row {
        display: flex;
        gap: 0.5rem;
        max-width: 80%;
    }

    .msg-row.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .msg-row.assistant {
        align-self: flex-start;
    }

    .msg-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .msg-row.assistant .msg-avatar {
        background: var(--gradient-primary);
        color: white;
    }

    .msg-row.user .msg-avatar {
        background: var(--primary-dark);
        color: white;
    }

    .msg-bubble {
        padding: 0.85rem 1.1rem;
        border-radius: 16px;
        line-height: 1.6;
        font-size: 0.95rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .msg-row.user .msg-bubble {
        background: var(--primary-dark);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .msg-row.assistant .msg-bubble {
        background: var(--bg-lighter);
        color: var(--text-dark);
        border: 1px solid var(--border-color, #e2e8f0);
        border-bottom-left-radius: 4px;
    }

    .msg-bubble p {
        margin: 0 0 0.5rem;
    }

    .msg-bubble p:last-child {
        margin-bottom: 0;
    }

    .msg-bubble ul, .msg-bubble ol {
        margin: 0.25rem 0 0.5rem 1.25rem;
        padding: 0;
    }

    .msg-bubble li {
        margin-bottom: 0.25rem;
    }

    .msg-bubble strong {
        font-weight: 600;
    }

    .msg-time {
        font-size: 0.7rem;
        color: #94a3b8;
        margin-top: 4px;
        padding: 0 0.25rem;
    }

    .msg-row.user .msg-time {
        text-align: right;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: none;
        align-self: flex-start;
        max-width: 80%;
    }

    .typing-indicator.visible {
        display: flex;
    }

    .typing-bubble {
        background: var(--bg-lighter);
        border: 1px solid var(--border-color, #e2e8f0);
        padding: 0.75rem 1rem;
        border-radius: 16px;
        border-bottom-left-radius: 4px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #64748b;
        font-size: 0.9rem;
    }

    .typing-dots {
        display: flex;
        gap: 3px;
    }

    .typing-dots span {
        width: 6px;
        height: 6px;
        background: var(--accent-green);
        border-radius: 50%;
        animation: typingBounce 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typingBounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-4px); }
    }

    /* ==============================
       WELCOME STATE
       ============================== */
    .welcome-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        text-align: center;
        padding: 2rem;
        color: #64748b;
    }

    .welcome-icon-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--gradient-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2.2rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 8px 25px rgba(30, 77, 139, 0.2);
    }

    .welcome-heading {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
    }

    .welcome-desc {
        font-size: 0.95rem;
        max-width: 480px;
        margin-bottom: 1.5rem;
        line-height: 1.6;
        color: #64748b;
    }

    .welcome-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        max-width: 520px;
    }

    .welcome-chip {
        padding: 0.6rem 1.1rem;
        background: var(--bg-lighter);
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 20px;
        font-size: 0.88rem;
        color: var(--text-dark);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .welcome-chip:hover {
        background: rgba(82, 183, 136, 0.08);
        border-color: var(--accent-green);
        color: var(--accent-green);
        transform: translateY(-1px);
    }

    /* ==============================
       INPUT AREA
       ============================== */
    .chat-input-area {
        padding: 0.75rem 1.25rem calc(0.75rem + env(safe-area-inset-bottom, 0px));
        background: var(--bg-lighter);
        border-top: 1px solid var(--border-color, #e2e8f0);
        flex-shrink: 0;
    }

    .input-box {
        display: flex;
        align-items: flex-end;
        gap: 0.75rem;
        background: var(--bg-light);
        border: 2px solid var(--border-color, #e2e8f0);
        border-radius: 16px;
        padding: 0.5rem 0.75rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .input-box:focus-within {
        border-color: var(--primary-dark);
        box-shadow: 0 0 0 3px rgba(30, 77, 139, 0.08);
    }

    .chat-textarea {
        flex: 1;
        border: none;
        background: transparent;
        resize: none;
        font-size: 0.95rem;
        font-family: inherit;
        line-height: 1.5;
        padding: 0.25rem 0;
        max-height: 120px;
        min-height: 24px;
        overflow-y: auto;
        outline: none;
        color: var(--text-dark);
    }

    .chat-textarea::placeholder {
        color: #94a3b8;
    }

    .btn-send {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: var(--gradient-primary);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
        font-size: 1rem;
    }

    .btn-send:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(30, 77, 139, 0.3);
    }

    .btn-send:disabled {
        opacity: 0.35;
        cursor: not-allowed;
    }

    .input-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.4rem;
        padding: 0 0.25rem;
    }

    .char-count {
        font-size: 0.75rem;
        color: #94a3b8;
    }

    .char-count.warning {
        color: #d97706;
    }

    .char-count.danger {
        color: #dc2626;
    }

    .msg-remaining {
        font-size: 0.75rem;
        color: #94a3b8;
    }

    /* ==============================
       UPGRADE OVERLAY
       ============================== */
    .upgrade-section {
        padding: 1.5rem;
        padding-bottom: calc(1.5rem + env(safe-area-inset-bottom, 0px));
        background: var(--bg-lighter);
        border-top: 1px solid var(--border-color, #e2e8f0);
        text-align: center;
        flex-shrink: 0;
    }

    .upgrade-card {
        background: linear-gradient(135deg, rgba(30, 77, 139, 0.06), rgba(82, 183, 136, 0.06));
        border: 1px solid rgba(30, 77, 139, 0.15);
        border-radius: 20px;
        padding: 1.75rem;
        max-width: 420px;
        margin: 0 auto;
    }

    .upgrade-card-icon {
        font-size: 2rem;
        margin-bottom: 0.75rem;
        color: var(--primary-dark);
    }

    .upgrade-card-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
    }

    .upgrade-card-text {
        font-size: 0.9rem;
        color: #64748b;
        margin-bottom: 1.25rem;
        line-height: 1.6;
    }

    .btn-upgrade {
        display: inline-block;
        padding: 0.8rem 2rem;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.95rem;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .btn-upgrade:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(30, 77, 139, 0.25);
        color: white;
        text-decoration: none;
    }

    .upgrade-trial-link {
        display: block;
        margin-top: 0.75rem;
        font-size: 0.85rem;
        color: #64748b;
        text-decoration: none;
    }

    .upgrade-trial-link:hover {
        color: var(--primary-dark);
        text-decoration: underline;
    }

    /* ==============================
       TOAST
       ============================== */
    .coach-toast {
        position: fixed;
        bottom: calc(100px + env(safe-area-inset-bottom, 0px));
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: #ef4444;
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 12px;
        font-size: 0.9rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        z-index: 100;
        opacity: 0;
        transition: all 0.3s ease;
        pointer-events: none;
        max-width: 90%;
        text-align: center;
    }

    .coach-toast.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    /* ==============================
       RESPONSIVE
       ============================== */
    @media (max-width: 768px) {
        .coach-sidebar {
            position: fixed;
            left: -280px;
            top: max(70px, calc(70px + env(safe-area-inset-top, 0px)));
            bottom: 0;
            transition: left 0.3s ease;
            box-shadow: none;
            z-index: 11;
        }

        .coach-sidebar.open {
            left: 0;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
        }

        .sidebar-toggle-btn {
            display: flex;
        }

        .sidebar-backdrop.visible {
            display: block;
        }

        .msg-row {
            max-width: 90%;
        }

        .chat-top-bar {
            padding-left: 3.5rem;
        }

        .welcome-chips {
            flex-direction: column;
            align-items: center;
        }

        .upgrade-card {
            padding: 1.25rem;
        }
    }

    @media (max-width: 480px) {
        .chat-messages {
            padding: 1rem 0.75rem;
        }

        .chat-input-area {
            padding: 0.5rem 0.75rem calc(0.5rem + env(safe-area-inset-bottom, 0px));
        }

        .msg-counter span.counter-text {
            display: none;
        }

        .msg-counter .counter-short {
            display: inline;
        }
    }

    @media (min-width: 481px) {
        .msg-counter .counter-short {
            display: none;
        }
    }

    /* ==============================
       DARK MODE
       ============================== */
    [data-theme="dark"] .coach-sidebar {
        background: #1a1f2e;
        border-color: #2d3548;
    }

    [data-theme="dark"] .sidebar-header {
        border-color: #2d3548;
    }

    [data-theme="dark"] .session-link {
        color: #cbd5e1;
    }

    [data-theme="dark"] .session-link:hover {
        background: rgba(30, 77, 139, 0.15);
        color: #e2e8f0;
    }

    [data-theme="dark"] .session-link.active {
        background: rgba(30, 77, 139, 0.25);
        color: #93c5fd;
    }

    [data-theme="dark"] .session-link-date {
        color: #64748b;
    }

    [data-theme="dark"] .sidebar-toggle-btn {
        background: #1a1f2e;
        border-color: #2d3548;
        color: #cbd5e1;
    }

    [data-theme="dark"] .chat-main {
        background: #111827;
    }

    [data-theme="dark"] .chat-top-bar {
        background: #1a1f2e;
        border-color: #2d3548;
    }

    [data-theme="dark"] .coach-info-name {
        color: #93c5fd;
    }

    [data-theme="dark"] .coach-info-label {
        color: #94a3b8;
    }

    [data-theme="dark"] .msg-counter {
        background: rgba(30, 77, 139, 0.2);
        color: #93c5fd;
    }

    [data-theme="dark"] .msg-counter i {
        color: #93c5fd;
    }

    [data-theme="dark"] .msg-counter.counter-low {
        background: #451a03;
        color: #fbbf24;
    }

    [data-theme="dark"] .msg-counter.counter-empty {
        background: #450a0a;
        color: #fca5a5;
    }

    [data-theme="dark"] .coach-disclaimer {
        background: #2a1f00;
        border-color: #a16207;
    }

    [data-theme="dark"] .disclaimer-bar:hover {
        background: rgba(251, 191, 36, 0.08);
    }

    [data-theme="dark"] .disclaimer-bar-left i {
        color: #fbbf24;
    }

    [data-theme="dark"] .disclaimer-bar-left strong {
        color: #fde68a;
    }

    [data-theme="dark"] .disclaimer-bar-left .disclaimer-crisis-inline {
        color: #fde68a;
    }

    [data-theme="dark"] .disclaimer-bar-left .disclaimer-crisis-inline a {
        color: #f87171;
    }

    [data-theme="dark"] .disclaimer-toggle-icon {
        color: #fde68a;
    }

    [data-theme="dark"] .disclaimer-text {
        color: #fcd34d;
    }

    [data-theme="dark"] .disclaimer-text a {
        color: #fde68a;
    }

    [data-theme="dark"] .disclaimer-crisis {
        border-color: rgba(251, 191, 36, 0.2);
        color: #fde68a;
    }

    [data-theme="dark"] .disclaimer-crisis i {
        color: #f87171;
    }

    [data-theme="dark"] .disclaimer-crisis a {
        color: #f87171;
    }

    [data-theme="dark"] .msg-row.assistant .msg-bubble {
        background: #1e2536;
        border-color: #2d3548;
        color: #e2e8f0;
    }

    [data-theme="dark"] .msg-time {
        color: #64748b;
    }

    [data-theme="dark"] .typing-bubble {
        background: #1e2536;
        border-color: #2d3548;
        color: #94a3b8;
    }

    [data-theme="dark"] .typing-dots span {
        background: #52b788;
    }

    [data-theme="dark"] .welcome-state {
        color: #94a3b8;
    }

    [data-theme="dark"] .welcome-heading {
        color: #93c5fd;
    }

    [data-theme="dark"] .welcome-desc {
        color: #94a3b8;
    }

    [data-theme="dark"] .welcome-chip {
        background: #1e2536;
        border-color: #2d3548;
        color: #cbd5e1;
    }

    [data-theme="dark"] .welcome-chip:hover {
        background: rgba(82, 183, 136, 0.12);
        border-color: #52b788;
        color: #6ee7b7;
    }

    [data-theme="dark"] .chat-input-area {
        background: #1a1f2e;
        border-color: #2d3548;
    }

    [data-theme="dark"] .input-box {
        background: #111827;
        border-color: #2d3548;
    }

    [data-theme="dark"] .input-box:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    [data-theme="dark"] .chat-textarea {
        color: #e2e8f0;
    }

    [data-theme="dark"] .chat-textarea::placeholder {
        color: #64748b;
    }

    [data-theme="dark"] .char-count,
    [data-theme="dark"] .msg-remaining {
        color: #64748b;
    }

    [data-theme="dark"] .upgrade-section {
        background: #1a1f2e;
        border-color: #2d3548;
    }

    [data-theme="dark"] .upgrade-card {
        background: linear-gradient(135deg, rgba(30, 77, 139, 0.15), rgba(82, 183, 136, 0.08));
        border-color: rgba(30, 77, 139, 0.3);
    }

    [data-theme="dark"] .upgrade-card-title {
        color: #93c5fd;
    }

    [data-theme="dark"] .upgrade-card-text {
        color: #94a3b8;
    }

    [data-theme="dark"] .upgrade-trial-link {
        color: #94a3b8;
    }

    [data-theme="dark"] .upgrade-trial-link:hover {
        color: #93c5fd;
    }

    [data-theme="dark"] .chat-messages::-webkit-scrollbar-thumb {
        background: #475569;
    }

    [data-theme="dark"] .sidebar-sessions::-webkit-scrollbar-thumb {
        background: #475569;
    }

    [data-theme="dark"] .sidebar-empty {
        color: #64748b;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Mobile sidebar toggle -->
<button class="sidebar-toggle-btn" id="sidebarToggle" aria-label="Toggle sessions">
    <i class="fas fa-bars"></i>
</button>

<!-- Mobile sidebar backdrop -->
<div class="sidebar-backdrop" id="sidebarBackdrop"></div>

<div class="coach-page">
    <!-- Session Sidebar -->
    <aside class="coach-sidebar" id="coachSidebar">
        <div class="sidebar-header">
            <form method="post" action="{% url 'accounts:coach_new_session' %}">
                {% csrf_token %}
                <button type="submit" class="btn-new-session">
                    <i class="fas fa-plus"></i>
                    New Conversation
                </button>
            </form>
        </div>
        <div class="sidebar-sessions">
            {% for s in sessions %}
            <a href="{% url 'accounts:coach_load_session' s.id %}"
               class="session-link {% if s.id == session.id %}active{% endif %}"
               title="{{ s.title|default:'New Conversation' }}">
                <div class="session-link-title">
                    <i class="fas fa-comment-dots" style="margin-right: 4px; font-size: 0.8rem; opacity: 0.4;"></i>
                    {{ s.title|default:"New Conversation"|truncatechars:35 }}
                </div>
                <div class="session-link-date">{{ s.updated_at|timesince }} ago</div>
            </a>
            {% empty %}
            <div class="sidebar-empty">
                <i class="fas fa-comment-medical"></i>
                Start your first conversation
            </div>
            {% endfor %}
        </div>
    </aside>

    <!-- Chat Area -->
    <main class="chat-main">
        <!-- Header -->
        <div class="chat-top-bar">
            <div class="chat-top-bar-left">
                <div class="coach-icon">
                    <i class="fas fa-heart-pulse"></i>
                </div>
                <div>
                    <div class="coach-info-name">
                        Recovery Coach
                        {% if is_premium %}
                        <span class="premium-tag"><i class="fas fa-crown"></i> Pro</span>
                        {% endif %}
                    </div>
                    <div class="coach-info-label">Pal &mdash; Your AI Companion</div>
                </div>
            </div>
            <div class="msg-counter {% if messages_used >= message_limit %}counter-empty{% elif message_limit > 0 and messages_used >= message_limit|add:"-2" %}counter-low{% endif %}" id="messagesCounter">
                <i class="fas fa-message"></i>
                <span class="counter-text">{{ messages_used }}/{{ message_limit }} {% if is_premium %}today{% else %}messages{% endif %}</span>
                <span class="counter-short">{{ messages_used }}/{{ message_limit }}</span>
            </div>
        </div>

        <!-- Disclaimer (collapsible) -->
        <div class="coach-disclaimer {% if not chat_messages %}expanded{% endif %}" id="coachDisclaimer">
            <div class="disclaimer-bar" onclick="document.getElementById('coachDisclaimer').classList.toggle('expanded')">
                <div class="disclaimer-bar-left">
                    <i class="fas fa-triangle-exclamation"></i>
                    <strong>AI tool, not a medical professional.</strong>
                    <span class="disclaimer-crisis-inline">Crisis? <a href="tel:988" onclick="event.stopPropagation()">988</a> | <a href="tel:911" onclick="event.stopPropagation()">911</a></span>
                </div>
                <i class="fas fa-chevron-down disclaimer-toggle-icon"></i>
            </div>
            <div class="disclaimer-details">
                <p class="disclaimer-text">
                    Pal is an AI-powered companion for general recovery support and encouragement only. It is <strong>not</strong> a licensed therapist, counselor, doctor, or medical provider. Pal cannot diagnose conditions, prescribe treatments, or provide medical advice. Responses are generated by artificial intelligence and may not always be accurate. Do not rely on Pal as a substitute for professional treatment, therapy, or medical care. Always consult a qualified healthcare provider for medical or mental health concerns.
                </p>
                <div class="disclaimer-crisis">
                    <i class="fas fa-phone-volume"></i>
                    In crisis or danger? Call <a href="tel:988">988</a> (Suicide & Crisis Lifeline) &bull; Text HOME to <a href="sms:741741">741741</a> &bull; Call <a href="tel:911">911</a> for emergencies
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chatMessages">
            {% if chat_messages %}
                {% for msg in chat_messages %}
                <div class="msg-row {{ msg.role }}">
                    <div class="msg-avatar">
                        {% if msg.role == 'assistant' %}
                        <i class="fas fa-heart-pulse"></i>
                        {% else %}
                        <i class="fas fa-user"></i>
                        {% endif %}
                    </div>
                    <div>
                        <div class="msg-bubble">{{ msg.content|linebreaksbr }}</div>
                        <div class="msg-time">{{ msg.created_at|date:"g:i A" }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Welcome state -->
                <div class="welcome-state" id="welcomeState">
                    <div class="welcome-icon-circle">
                        <i class="fas fa-heart-pulse"></i>
                    </div>
                    <div class="welcome-heading">Hi, I'm Pal</div>
                    <div class="welcome-desc">
                        I'm your AI recovery companion. I'm here to listen, support, and encourage you on your journey.
                        Whether you need to talk through cravings, celebrate a milestone, or just process your day &mdash; I'm here for you.
                    </div>
                    <div class="welcome-chips">
                        <div class="welcome-chip" data-suggestion="I'm having a tough day and could use some support.">
                            <i class="fas fa-cloud-rain" style="margin-right: 4px; opacity: 0.6;"></i> Having a tough day
                        </div>
                        <div class="welcome-chip" data-suggestion="I want to celebrate a milestone in my recovery.">
                            <i class="fas fa-trophy" style="margin-right: 4px; opacity: 0.6;"></i> Celebrate a milestone
                        </div>
                        <div class="welcome-chip" data-suggestion="Can you help me with some coping strategies for cravings?">
                            <i class="fas fa-hand-holding-heart" style="margin-right: 4px; opacity: 0.6;"></i> Coping with cravings
                        </div>
                        <div class="welcome-chip" data-suggestion="I'd like to talk about my recovery goals.">
                            <i class="fas fa-bullseye" style="margin-right: 4px; opacity: 0.6;"></i> Recovery goals
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Typing indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="msg-avatar" style="background: var(--gradient-primary); color: white;">
                    <i class="fas fa-heart-pulse"></i>
                </div>
                <div class="typing-bubble">
                    Pal is thinking
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input area or upgrade prompt -->
        {% if limit_reason == "upgrade_required" %}
        <div class="upgrade-section">
            <div class="upgrade-card">
                <div class="upgrade-card-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="upgrade-card-title">You've used all 3 free messages</div>
                <div class="upgrade-card-text">
                    Upgrade to Premium for 20 messages per day with Pal, plus unlimited groups, advanced analytics, and more.
                </div>
                <a href="{% url 'accounts:pricing' %}" class="btn-upgrade">
                    <i class="fas fa-crown"></i> Upgrade to Premium
                </a>
                <a href="{% url 'accounts:pricing' %}" class="upgrade-trial-link">
                    Try Premium Free for 14 Days
                </a>
            </div>
        </div>
        {% else %}
        <div class="chat-input-area">
            <div class="input-box">
                <textarea
                    class="chat-textarea"
                    id="chatInput"
                    placeholder="Type your message to Pal..."
                    rows="1"
                    maxlength="2000"
                    {% if not can_send %}disabled{% endif %}
                ></textarea>
                <button class="btn-send" id="sendBtn" disabled aria-label="Send message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="input-meta">
                <span class="char-count" id="charCounter">0 / 2000</span>
                <span class="msg-remaining" id="remainingLabel">
                    {{ messages_used }}/{{ message_limit }} messages used {% if is_premium %}today{% endif %}
                </span>
            </div>
        </div>
        {% endif %}
    </main>
</div>

<!-- Toast notification -->
<div class="coach-toast" id="coachToast"></div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // DOM refs
    var chatMessages = document.getElementById('chatMessages');
    var chatInput = document.getElementById('chatInput');
    var sendBtn = document.getElementById('sendBtn');
    var typingIndicator = document.getElementById('typingIndicator');
    var charCounter = document.getElementById('charCounter');
    var remainingLabel = document.getElementById('remainingLabel');
    var messagesCounter = document.getElementById('messagesCounter');
    var welcomeState = document.getElementById('welcomeState');
    var sidebarToggle = document.getElementById('sidebarToggle');
    var sidebar = document.getElementById('coachSidebar');
    var sidebarBackdrop = document.getElementById('sidebarBackdrop');
    var toast = document.getElementById('coachToast');
    var sessionId = {{ session.id }};
    var isPremium = {{ is_premium|yesno:"true,false" }};
    var messagesUsed = {{ messages_used }};
    var messageLimit = {{ message_limit }};
    var isSending = false;

    // CSRF helper
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Scroll to bottom
    function scrollToBottom() {
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // Show toast
    function showToast(message, duration) {
        duration = duration || 4000;
        if (!toast) return;
        toast.textContent = message;
        toast.classList.add('visible');
        setTimeout(function() {
            toast.classList.remove('visible');
        }, duration);
    }

    // Auto-grow textarea
    function autoGrow() {
        if (!chatInput) return;
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    }

    // Update char counter
    function updateCharCounter() {
        if (!chatInput || !charCounter) return;
        var len = chatInput.value.length;
        charCounter.textContent = len + ' / 2000';
        charCounter.classList.remove('warning', 'danger');
        if (len > 1800) {
            charCounter.classList.add('danger');
        } else if (len > 1500) {
            charCounter.classList.add('warning');
        }
    }

    // Update send button state
    function updateSendBtn() {
        if (!sendBtn || !chatInput) return;
        sendBtn.disabled = isSending || chatInput.value.trim().length === 0;
    }

    // Update messages remaining display
    function updateMessagesDisplay() {
        if (messagesCounter) {
            var counterText = messagesCounter.querySelector('.counter-text');
            var counterShort = messagesCounter.querySelector('.counter-short');
            var label = isPremium ? 'today' : 'messages';
            if (counterText) counterText.textContent = messagesUsed + '/' + messageLimit + ' ' + label;
            if (counterShort) counterShort.textContent = messagesUsed + '/' + messageLimit;

            messagesCounter.classList.remove('counter-low', 'counter-empty');
            if (messagesUsed >= messageLimit) {
                messagesCounter.classList.add('counter-empty');
            } else if (messagesUsed >= messageLimit - 2) {
                messagesCounter.classList.add('counter-low');
            }
        }

        if (remainingLabel) {
            var label = isPremium ? ' messages used today' : ' messages used';
            remainingLabel.textContent = messagesUsed + '/' + messageLimit + label;
        }
    }

    // Create a message bubble element
    function createMessageBubble(role, content, timeStr) {
        var row = document.createElement('div');
        row.className = 'msg-row ' + role;

        var avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        var icon = document.createElement('i');
        icon.className = role === 'assistant' ? 'fas fa-heart-pulse' : 'fas fa-user';
        avatar.appendChild(icon);

        var bodyDiv = document.createElement('div');

        var bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.innerHTML = content.replace(/\n/g, '<br>');

        var time = document.createElement('div');
        time.className = 'msg-time';
        time.textContent = timeStr;

        bodyDiv.appendChild(bubble);
        bodyDiv.appendChild(time);

        row.appendChild(avatar);
        row.appendChild(bodyDiv);

        return row;
    }

    // Format current time
    function formatTime() {
        var now = new Date();
        var hours = now.getHours();
        var minutes = now.getMinutes();
        var ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        minutes = minutes < 10 ? '0' + minutes : minutes;
        return hours + ':' + minutes + ' ' + ampm;
    }

    // Send message
    function sendMessage() {
        if (isSending || !chatInput) return;

        var message = chatInput.value.trim();
        if (!message) return;

        isSending = true;
        updateSendBtn();

        // Hide welcome state if visible
        if (welcomeState) {
            welcomeState.remove();
        }

        // Show user message immediately
        var userBubble = createMessageBubble('user', message, formatTime());
        chatMessages.insertBefore(userBubble, typingIndicator);

        // Clear input
        chatInput.value = '';
        chatInput.style.height = 'auto';
        updateCharCounter();

        // Show typing indicator
        if (typingIndicator) {
            typingIndicator.classList.add('visible');
        }
        scrollToBottom();

        // Send AJAX request
        var formData = new FormData();
        formData.append('message', message);
        formData.append('session_id', sessionId);

        fetch("{% url 'accounts:coach_send_message' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(function(response) {
            if (!response.ok) {
                return response.json().then(function(data) {
                    throw data;
                });
            }
            return response.json();
        })
        .then(function(data) {
            // Hide typing
            if (typingIndicator) {
                typingIndicator.classList.remove('visible');
            }

            // Show assistant response
            var assistantBubble = createMessageBubble('assistant', data.response, formatTime());
            chatMessages.insertBefore(assistantBubble, typingIndicator);

            // Update counters
            messagesUsed = data.messages_used;
            messageLimit = data.message_limit;
            updateMessagesDisplay();

            scrollToBottom();
            isSending = false;
            updateSendBtn();

            // If limit reached, show message and reload to get upgrade UI
            if (messagesUsed >= messageLimit) {
                showToast('You have used all your available messages.', 5000);
                setTimeout(function() {
                    window.location.reload();
                }, 3000);
            }
        })
        .catch(function(err) {
            // Hide typing
            if (typingIndicator) {
                typingIndicator.classList.remove('visible');
            }

            var errorMsg = (err && err.error) ? err.error : 'Something went wrong. Please try again.';

            if (err && err.upgrade_required) {
                showToast('Message limit reached. Upgrade to Premium for more.', 5000);
                setTimeout(function() {
                    window.location.reload();
                }, 2000);
            } else {
                showToast(errorMsg);
            }

            isSending = false;
            updateSendBtn();
            scrollToBottom();
        });
    }

    // Event listeners
    if (chatInput) {
        chatInput.addEventListener('input', function() {
            autoGrow();
            updateCharCounter();
            updateSendBtn();
        });

        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }

    // Suggestion chips
    document.querySelectorAll('.welcome-chip').forEach(function(chip) {
        chip.addEventListener('click', function() {
            if (!chatInput) return;
            chatInput.value = this.getAttribute('data-suggestion');
            autoGrow();
            updateCharCounter();
            updateSendBtn();
            chatInput.focus();
        });
    });

    // Sidebar toggle (mobile)
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
            sidebarBackdrop.classList.toggle('visible');
        });
    }

    if (sidebarBackdrop) {
        sidebarBackdrop.addEventListener('click', function() {
            sidebar.classList.remove('open');
            sidebarBackdrop.classList.remove('visible');
        });
    }

    // Initial scroll to bottom
    scrollToBottom();
    updateSendBtn();
})();
</script>
{% endblock %}
