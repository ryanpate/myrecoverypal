{% extends 'base.html' %}
{% load static %}

{% block title %}Recovery Coach - MyRecoveryPal{% endblock %}

{% block extra_css %}
<style>
    /* Coach Layout */
    .coach-wrapper {
        display: flex;
        height: calc(100vh - 70px);
        max-width: 100%;
        overflow: hidden;
    }

    /* Session Sidebar */
    .coach-sidebar {
        width: 280px;
        min-width: 280px;
        background: white;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        z-index: 10;
    }

    .sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .new-session-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #1e4d8b, #2563eb);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .new-session-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 77, 139, 0.3);
    }

    .sidebar-sessions {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .sidebar-sessions::-webkit-scrollbar {
        width: 4px;
    }

    .sidebar-sessions::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 2px;
    }

    .session-item {
        display: block;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        color: #374151;
        transition: all 0.2s ease;
        margin-bottom: 2px;
        cursor: pointer;
    }

    .session-item:hover {
        background: #f3f4f6;
        color: #374151;
        text-decoration: none;
    }

    .session-item.active {
        background: linear-gradient(135deg, rgba(30, 77, 139, 0.1), rgba(37, 99, 235, 0.08));
        color: #1e4d8b;
        font-weight: 500;
    }

    .session-title {
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 2px;
    }

    .session-date {
        font-size: 0.75rem;
        color: #9ca3af;
    }

    .session-item.active .session-date {
        color: #6b7280;
    }

    /* Mobile sidebar toggle */
    .sidebar-toggle {
        display: none;
        position: fixed;
        top: 80px;
        left: 10px;
        z-index: 20;
        width: 40px;
        height: 40px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        color: #374151;
        font-size: 1.1rem;
    }

    .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 9;
    }

    /* Chat Area */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background: #f9fafb;
    }

    .chat-header {
        padding: 0.75rem 1.25rem;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .coach-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2dd4bf, #10b981);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .coach-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1f2937;
        line-height: 1.2;
    }

    .coach-subtitle {
        font-size: 0.8rem;
        color: #6b7280;
    }

    .messages-counter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.85rem;
        background: #f3f4f6;
        border-radius: 20px;
        font-size: 0.85rem;
        color: #4b5563;
        font-weight: 500;
        flex-shrink: 0;
    }

    .messages-counter i {
        color: #1e4d8b;
    }

    .counter-low {
        background: #fef3c7;
        color: #92400e;
    }

    .counter-low i {
        color: #d97706;
    }

    .counter-empty {
        background: #fee2e2;
        color: #991b1b;
    }

    .counter-empty i {
        color: #dc2626;
    }

    /* Crisis banner */
    .crisis-banner {
        padding: 0.5rem 1.25rem;
        background: #fffbeb;
        border-bottom: 1px solid #fde68a;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: #92400e;
        flex-shrink: 0;
    }

    .crisis-banner a {
        color: #b45309;
        font-weight: 600;
        text-decoration: underline;
    }

    .crisis-banner a:hover {
        color: #92400e;
    }

    /* Messages Area */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        scroll-behavior: smooth;
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
    }

    /* Message Bubbles */
    .message-row {
        display: flex;
        gap: 0.5rem;
        max-width: 80%;
    }

    .message-row.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message-row.assistant {
        align-self: flex-start;
    }

    .message-avatar-small {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .message-row.assistant .message-avatar-small {
        background: linear-gradient(135deg, #2dd4bf, #10b981);
        color: white;
    }

    .message-row.user .message-avatar-small {
        background: linear-gradient(135deg, #1e4d8b, #2563eb);
        color: white;
    }

    .message-bubble {
        padding: 0.75rem 1rem;
        border-radius: 16px;
        line-height: 1.55;
        font-size: 0.95rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .message-row.user .message-bubble {
        background: #1e4d8b;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-row.assistant .message-bubble {
        background: #f3f4f6;
        color: #1f2937;
        border-bottom-left-radius: 4px;
    }

    .message-bubble p {
        margin: 0 0 0.5rem;
    }

    .message-bubble p:last-child {
        margin-bottom: 0;
    }

    .message-bubble ul, .message-bubble ol {
        margin: 0.25rem 0 0.5rem 1.25rem;
        padding: 0;
    }

    .message-bubble li {
        margin-bottom: 0.25rem;
    }

    .message-bubble strong {
        font-weight: 600;
    }

    .message-time {
        font-size: 0.7rem;
        color: #9ca3af;
        margin-top: 4px;
        padding: 0 0.25rem;
    }

    .message-row.user .message-time {
        text-align: right;
    }

    /* Typing indicator */
    .typing-indicator {
        display: none;
        align-self: flex-start;
        max-width: 80%;
    }

    .typing-indicator.visible {
        display: flex;
    }

    .typing-bubble {
        background: #f3f4f6;
        padding: 0.75rem 1rem;
        border-radius: 16px;
        border-bottom-left-radius: 4px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        font-size: 0.9rem;
    }

    .typing-dots {
        display: flex;
        gap: 3px;
    }

    .typing-dots span {
        width: 6px;
        height: 6px;
        background: #9ca3af;
        border-radius: 50%;
        animation: typingBounce 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typingBounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-4px); }
    }

    /* Welcome / Empty state */
    .welcome-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }

    .welcome-icon {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2dd4bf, #10b981);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        margin-bottom: 1.25rem;
    }

    .welcome-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .welcome-text {
        font-size: 0.95rem;
        max-width: 480px;
        margin-bottom: 1.5rem;
        line-height: 1.5;
    }

    .welcome-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        max-width: 500px;
    }

    .suggestion-chip {
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        font-size: 0.85rem;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .suggestion-chip:hover {
        background: #f0fdf4;
        border-color: #10b981;
        color: #065f46;
    }

    /* Input Area */
    .chat-input-area {
        padding: 0.75rem 1.25rem 1rem;
        background: white;
        border-top: 1px solid #e5e7eb;
        flex-shrink: 0;
    }

    .input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 0.75rem;
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 16px;
        padding: 0.5rem 0.75rem;
        transition: border-color 0.2s ease;
    }

    .input-wrapper:focus-within {
        border-color: #1e4d8b;
        background: white;
    }

    .chat-textarea {
        flex: 1;
        border: none;
        background: transparent;
        resize: none;
        font-size: 0.95rem;
        font-family: inherit;
        line-height: 1.5;
        padding: 0.25rem 0;
        max-height: 120px;
        min-height: 24px;
        overflow-y: auto;
        outline: none;
    }

    .chat-textarea::placeholder {
        color: #9ca3af;
    }

    .send-btn {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: linear-gradient(135deg, #1e4d8b, #2563eb);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
        font-size: 1rem;
    }

    .send-btn:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(30, 77, 139, 0.3);
    }

    .send-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .input-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.4rem;
        padding: 0 0.25rem;
    }

    .char-counter {
        font-size: 0.75rem;
        color: #9ca3af;
    }

    .char-counter.warning {
        color: #d97706;
    }

    .char-counter.danger {
        color: #dc2626;
    }

    .remaining-label {
        font-size: 0.75rem;
        color: #9ca3af;
    }

    /* Upgrade Overlay */
    .upgrade-overlay {
        padding: 1.5rem;
        background: white;
        border-top: 1px solid #e5e7eb;
        text-align: center;
        flex-shrink: 0;
    }

    .upgrade-card {
        background: linear-gradient(135deg, #eff6ff, #f0fdf4);
        border: 1px solid #bfdbfe;
        border-radius: 16px;
        padding: 1.5rem;
        max-width: 420px;
        margin: 0 auto;
    }

    .upgrade-icon {
        font-size: 2rem;
        margin-bottom: 0.75rem;
    }

    .upgrade-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e4d8b;
        margin-bottom: 0.5rem;
    }

    .upgrade-text {
        font-size: 0.9rem;
        color: #4b5563;
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .upgrade-btn {
        display: inline-block;
        padding: 0.75rem 2rem;
        background: linear-gradient(135deg, #1e4d8b, #2563eb);
        color: white;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.95rem;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upgrade-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(30, 77, 139, 0.3);
        color: white;
        text-decoration: none;
    }

    .upgrade-secondary {
        display: block;
        margin-top: 0.75rem;
        font-size: 0.85rem;
        color: #6b7280;
        text-decoration: none;
    }

    .upgrade-secondary:hover {
        color: #1e4d8b;
        text-decoration: underline;
    }

    /* Toast notifications */
    .coach-toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: #ef4444;
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 10px;
        font-size: 0.9rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        z-index: 100;
        opacity: 0;
        transition: all 0.3s ease;
        pointer-events: none;
        max-width: 90%;
        text-align: center;
    }

    .coach-toast.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    /* Premium badge */
    .premium-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.15rem 0.5rem;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .coach-sidebar {
            position: fixed;
            left: -280px;
            top: 70px;
            bottom: 0;
            transition: left 0.3s ease;
            box-shadow: none;
            z-index: 11;
        }

        .coach-sidebar.open {
            left: 0;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
        }

        .sidebar-toggle {
            display: flex;
        }

        .sidebar-overlay.visible {
            display: block;
        }

        .message-row {
            max-width: 90%;
        }

        .chat-header {
            padding-left: 3.5rem;
        }

        .welcome-suggestions {
            flex-direction: column;
            align-items: center;
        }

        .upgrade-card {
            padding: 1rem;
        }
    }

    @media (max-width: 480px) {
        .chat-messages {
            padding: 1rem 0.75rem;
        }

        .chat-input-area {
            padding: 0.5rem 0.75rem 0.75rem;
        }

        .messages-counter span {
            display: none;
        }

        .messages-counter .counter-number {
            display: inline;
        }
    }

    /* Dark mode */
    [data-theme="dark"] .coach-sidebar {
        background: #1f2937;
        border-color: #374151;
    }

    [data-theme="dark"] .sidebar-header {
        border-color: #374151;
    }

    [data-theme="dark"] .session-item {
        color: #d1d5db;
    }

    [data-theme="dark"] .session-item:hover {
        background: #374151;
        color: #e5e7eb;
    }

    [data-theme="dark"] .session-item.active {
        background: rgba(30, 77, 139, 0.25);
        color: #93c5fd;
    }

    [data-theme="dark"] .session-date {
        color: #6b7280;
    }

    [data-theme="dark"] .sidebar-toggle {
        background: #1f2937;
        border-color: #374151;
        color: #d1d5db;
    }

    [data-theme="dark"] .chat-area {
        background: #111827;
    }

    [data-theme="dark"] .chat-header {
        background: #1f2937;
        border-color: #374151;
    }

    [data-theme="dark"] .coach-name {
        color: #f3f4f6;
    }

    [data-theme="dark"] .coach-subtitle {
        color: #9ca3af;
    }

    [data-theme="dark"] .messages-counter {
        background: #374151;
        color: #d1d5db;
    }

    [data-theme="dark"] .messages-counter i {
        color: #93c5fd;
    }

    [data-theme="dark"] .counter-low {
        background: #451a03;
        color: #fbbf24;
    }

    [data-theme="dark"] .counter-empty {
        background: #450a0a;
        color: #fca5a5;
    }

    [data-theme="dark"] .crisis-banner {
        background: #1c1917;
        border-color: #44403c;
        color: #d6d3d1;
    }

    [data-theme="dark"] .crisis-banner a {
        color: #fbbf24;
    }

    [data-theme="dark"] .message-row.assistant .message-bubble {
        background: #374151;
        color: #e5e7eb;
    }

    [data-theme="dark"] .message-time {
        color: #6b7280;
    }

    [data-theme="dark"] .typing-bubble {
        background: #374151;
        color: #9ca3af;
    }

    [data-theme="dark"] .typing-dots span {
        background: #6b7280;
    }

    [data-theme="dark"] .welcome-state {
        color: #9ca3af;
    }

    [data-theme="dark"] .welcome-title {
        color: #f3f4f6;
    }

    [data-theme="dark"] .suggestion-chip {
        background: #1f2937;
        border-color: #374151;
        color: #d1d5db;
    }

    [data-theme="dark"] .suggestion-chip:hover {
        background: #064e3b;
        border-color: #10b981;
        color: #6ee7b7;
    }

    [data-theme="dark"] .chat-input-area {
        background: #1f2937;
        border-color: #374151;
    }

    [data-theme="dark"] .input-wrapper {
        background: #111827;
        border-color: #374151;
    }

    [data-theme="dark"] .input-wrapper:focus-within {
        border-color: #3b82f6;
        background: #1f2937;
    }

    [data-theme="dark"] .chat-textarea {
        color: #e5e7eb;
    }

    [data-theme="dark"] .chat-textarea::placeholder {
        color: #6b7280;
    }

    [data-theme="dark"] .char-counter {
        color: #6b7280;
    }

    [data-theme="dark"] .remaining-label {
        color: #6b7280;
    }

    [data-theme="dark"] .upgrade-overlay {
        background: #1f2937;
        border-color: #374151;
    }

    [data-theme="dark"] .upgrade-card {
        background: linear-gradient(135deg, #1e3a5f, #064e3b);
        border-color: #1e4d8b;
    }

    [data-theme="dark"] .upgrade-title {
        color: #93c5fd;
    }

    [data-theme="dark"] .upgrade-text {
        color: #d1d5db;
    }

    [data-theme="dark"] .upgrade-secondary {
        color: #9ca3af;
    }

    [data-theme="dark"] .upgrade-secondary:hover {
        color: #93c5fd;
    }

    [data-theme="dark"] .chat-messages::-webkit-scrollbar-thumb {
        background: #4b5563;
    }

    [data-theme="dark"] .sidebar-sessions::-webkit-scrollbar-thumb {
        background: #4b5563;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Mobile sidebar toggle -->
<button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sessions">
    <i class="fas fa-bars"></i>
</button>

<!-- Mobile sidebar overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="coach-wrapper">
    <!-- Session Sidebar -->
    <aside class="coach-sidebar" id="coachSidebar">
        <div class="sidebar-header">
            <form method="post" action="{% url 'accounts:coach_new_session' %}">
                {% csrf_token %}
                <button type="submit" class="new-session-btn">
                    <i class="fas fa-plus"></i>
                    New Conversation
                </button>
            </form>
        </div>
        <div class="sidebar-sessions">
            {% for s in sessions %}
            <a href="{% url 'accounts:coach_load_session' s.id %}"
               class="session-item {% if s.id == session.id %}active{% endif %}"
               title="{{ s.title|default:'New Conversation' }}">
                <div class="session-title">
                    <i class="fas fa-comment-dots" style="margin-right: 4px; font-size: 0.8rem; opacity: 0.5;"></i>
                    {{ s.title|default:"New Conversation"|truncatechars:35 }}
                </div>
                <div class="session-date">{{ s.updated_at|timesince }} ago</div>
            </a>
            {% empty %}
            <div style="padding: 1.5rem 1rem; text-align: center; color: #9ca3af; font-size: 0.85rem;">
                <i class="fas fa-comment-medical" style="font-size: 1.5rem; margin-bottom: 0.5rem; display: block; opacity: 0.4;"></i>
                Start your first conversation
            </div>
            {% endfor %}
        </div>
    </aside>

    <!-- Chat Area -->
    <main class="chat-area">
        <!-- Header -->
        <div class="chat-header">
            <div class="chat-header-left">
                <div class="coach-avatar">
                    <i class="fas fa-heart-pulse"></i>
                </div>
                <div>
                    <div class="coach-name">
                        Recovery Coach
                        {% if is_premium %}
                        <span class="premium-badge"><i class="fas fa-crown"></i> Pro</span>
                        {% endif %}
                    </div>
                    <div class="coach-subtitle">Pal &mdash; Your AI companion</div>
                </div>
            </div>
            <div class="messages-counter {% if messages_used >= message_limit %}counter-empty{% elif message_limit > 0 and messages_used >= message_limit|add:"-2" %}counter-low{% endif %}" id="messagesCounter">
                <i class="fas fa-message"></i>
                <span>{{ messages_used }}/{{ message_limit }} {% if is_premium %}today{% else %}messages{% endif %}</span>
                <span class="counter-number" style="display:none;">{{ messages_used }}/{{ message_limit }}</span>
            </div>
        </div>

        <!-- Crisis disclaimer -->
        <div class="crisis-banner">
            <i class="fas fa-info-circle"></i>
            Pal is an AI companion, not a licensed therapist. In crisis? Call
            <a href="tel:988">988</a> or text HOME to
            <a href="sms:741741">741741</a>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chatMessages">
            {% if messages %}
                {% for msg in messages %}
                <div class="message-row {{ msg.role }}">
                    <div class="message-avatar-small">
                        {% if msg.role == 'assistant' %}
                        <i class="fas fa-heart-pulse"></i>
                        {% else %}
                        <i class="fas fa-user"></i>
                        {% endif %}
                    </div>
                    <div>
                        <div class="message-bubble">{{ msg.content|linebreaksbr }}</div>
                        <div class="message-time">{{ msg.created_at|date:"g:i A" }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Welcome state -->
                <div class="welcome-state" id="welcomeState">
                    <div class="welcome-icon">
                        <i class="fas fa-heart-pulse"></i>
                    </div>
                    <div class="welcome-title">Hi, I'm Pal</div>
                    <div class="welcome-text">
                        I'm your AI recovery companion. I'm here to listen, support, and encourage you on your journey.
                        Whether you need to talk through cravings, celebrate a milestone, or just process your day, I'm here for you.
                    </div>
                    <div class="welcome-suggestions">
                        <div class="suggestion-chip" data-suggestion="I'm having a tough day and could use some support.">
                            Having a tough day
                        </div>
                        <div class="suggestion-chip" data-suggestion="I want to celebrate a milestone in my recovery.">
                            Celebrate a milestone
                        </div>
                        <div class="suggestion-chip" data-suggestion="Can you help me with some coping strategies for cravings?">
                            Coping with cravings
                        </div>
                        <div class="suggestion-chip" data-suggestion="I'd like to talk about my recovery goals.">
                            Recovery goals
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Typing indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar-small" style="background: linear-gradient(135deg, #2dd4bf, #10b981); color: white;">
                    <i class="fas fa-heart-pulse"></i>
                </div>
                <div class="typing-bubble">
                    Pal is thinking
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input area or upgrade prompt -->
        {% if limit_reason == "upgrade_required" %}
        <div class="upgrade-overlay">
            <div class="upgrade-card">
                <div class="upgrade-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="upgrade-title">You've used all 3 free messages</div>
                <div class="upgrade-text">
                    Upgrade to Premium for 20 messages per day with Pal, plus unlimited groups, messaging, and more.
                </div>
                <a href="{% url 'accounts:pricing' %}" class="upgrade-btn">
                    <i class="fas fa-crown"></i> Upgrade to Premium
                </a>
                <a href="{% url 'accounts:pricing' %}" class="upgrade-secondary">
                    Try Premium Free for 14 Days
                </a>
            </div>
        </div>
        {% else %}
        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea
                    class="chat-textarea"
                    id="chatInput"
                    placeholder="Type your message..."
                    rows="1"
                    maxlength="2000"
                    {% if not can_send %}disabled{% endif %}
                ></textarea>
                <button class="send-btn" id="sendBtn" disabled aria-label="Send message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="input-footer">
                <span class="char-counter" id="charCounter">0 / 2000</span>
                <span class="remaining-label" id="remainingLabel">
                    {{ messages_used }}/{{ message_limit }} messages used {% if is_premium %}today{% endif %}
                </span>
            </div>
        </div>
        {% endif %}
    </main>
</div>

<!-- Toast notification -->
<div class="coach-toast" id="coachToast"></div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // DOM refs
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const charCounter = document.getElementById('charCounter');
    const remainingLabel = document.getElementById('remainingLabel');
    const messagesCounter = document.getElementById('messagesCounter');
    const welcomeState = document.getElementById('welcomeState');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('coachSidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const toast = document.getElementById('coachToast');
    const sessionId = {{ session.id }};
    const isPremium = {{ is_premium|yesno:"true,false" }};
    let messagesUsed = {{ messages_used }};
    let messageLimit = {{ message_limit }};
    let isSending = false;

    // CSRF helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Scroll to bottom
    function scrollToBottom() {
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // Show toast
    function showToast(message, duration) {
        duration = duration || 4000;
        if (!toast) return;
        toast.textContent = message;
        toast.classList.add('visible');
        setTimeout(function() {
            toast.classList.remove('visible');
        }, duration);
    }

    // Auto-grow textarea
    function autoGrow() {
        if (!chatInput) return;
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    }

    // Update char counter
    function updateCharCounter() {
        if (!chatInput || !charCounter) return;
        var len = chatInput.value.length;
        charCounter.textContent = len + ' / 2000';
        charCounter.classList.remove('warning', 'danger');
        if (len > 1800) {
            charCounter.classList.add('danger');
        } else if (len > 1500) {
            charCounter.classList.add('warning');
        }
    }

    // Update send button state
    function updateSendBtn() {
        if (!sendBtn || !chatInput) return;
        sendBtn.disabled = isSending || chatInput.value.trim().length === 0;
    }

    // Update messages remaining display
    function updateMessagesDisplay() {
        if (messagesCounter) {
            var counterSpan = messagesCounter.querySelector('span:not(.counter-number)');
            var counterNumber = messagesCounter.querySelector('.counter-number');
            var label = isPremium ? 'today' : 'messages';
            if (counterSpan) counterSpan.textContent = messagesUsed + '/' + messageLimit + ' ' + label;
            if (counterNumber) counterNumber.textContent = messagesUsed + '/' + messageLimit;

            messagesCounter.classList.remove('counter-low', 'counter-empty');
            if (messagesUsed >= messageLimit) {
                messagesCounter.classList.add('counter-empty');
            } else if (messagesUsed >= messageLimit - 2) {
                messagesCounter.classList.add('counter-low');
            }
        }

        if (remainingLabel) {
            var label = isPremium ? ' messages used today' : ' messages used';
            remainingLabel.textContent = messagesUsed + '/' + messageLimit + label;
        }
    }

    // Create a message bubble element
    function createMessageBubble(role, content, timeStr) {
        var row = document.createElement('div');
        row.className = 'message-row ' + role;

        var avatar = document.createElement('div');
        avatar.className = 'message-avatar-small';
        var icon = document.createElement('i');
        icon.className = role === 'assistant' ? 'fas fa-heart-pulse' : 'fas fa-user';
        avatar.appendChild(icon);

        var bodyDiv = document.createElement('div');

        var bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        // Convert newlines to <br> for display
        bubble.innerHTML = content.replace(/\n/g, '<br>');

        var time = document.createElement('div');
        time.className = 'message-time';
        time.textContent = timeStr;

        bodyDiv.appendChild(bubble);
        bodyDiv.appendChild(time);

        row.appendChild(avatar);
        row.appendChild(bodyDiv);

        return row;
    }

    // Format current time
    function formatTime() {
        var now = new Date();
        var hours = now.getHours();
        var minutes = now.getMinutes();
        var ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        minutes = minutes < 10 ? '0' + minutes : minutes;
        return hours + ':' + minutes + ' ' + ampm;
    }

    // Send message
    function sendMessage() {
        if (isSending || !chatInput) return;

        var message = chatInput.value.trim();
        if (!message) return;

        isSending = true;
        updateSendBtn();

        // Hide welcome state if visible
        if (welcomeState) {
            welcomeState.remove();
        }

        // Show user message immediately
        var userBubble = createMessageBubble('user', message, formatTime());
        chatMessages.insertBefore(userBubble, typingIndicator);

        // Clear input
        chatInput.value = '';
        chatInput.style.height = 'auto';
        updateCharCounter();

        // Show typing indicator
        if (typingIndicator) {
            typingIndicator.classList.add('visible');
        }
        scrollToBottom();

        // Send AJAX request
        var formData = new FormData();
        formData.append('message', message);
        formData.append('session_id', sessionId);

        fetch("{% url 'accounts:coach_send_message' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(function(response) {
            if (!response.ok) {
                return response.json().then(function(data) {
                    throw data;
                });
            }
            return response.json();
        })
        .then(function(data) {
            // Hide typing
            if (typingIndicator) {
                typingIndicator.classList.remove('visible');
            }

            // Show assistant response
            var assistantBubble = createMessageBubble('assistant', data.response, formatTime());
            chatMessages.insertBefore(assistantBubble, typingIndicator);

            // Update counters
            messagesUsed = data.messages_used;
            messageLimit = data.message_limit;
            updateMessagesDisplay();

            scrollToBottom();
            isSending = false;
            updateSendBtn();

            // If limit reached, show message and reload to get upgrade UI
            if (messagesUsed >= messageLimit) {
                showToast('You have used all your available messages.', 5000);
                setTimeout(function() {
                    window.location.reload();
                }, 3000);
            }
        })
        .catch(function(err) {
            // Hide typing
            if (typingIndicator) {
                typingIndicator.classList.remove('visible');
            }

            var errorMsg = (err && err.error) ? err.error : 'Something went wrong. Please try again.';

            if (err && err.upgrade_required) {
                showToast('Message limit reached. Upgrade to Premium for more.', 5000);
                setTimeout(function() {
                    window.location.reload();
                }, 2000);
            } else {
                showToast(errorMsg);
            }

            isSending = false;
            updateSendBtn();
            scrollToBottom();
        });
    }

    // Event listeners
    if (chatInput) {
        chatInput.addEventListener('input', function() {
            autoGrow();
            updateCharCounter();
            updateSendBtn();
        });

        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }

    // Suggestion chips
    document.querySelectorAll('.suggestion-chip').forEach(function(chip) {
        chip.addEventListener('click', function() {
            if (!chatInput) return;
            chatInput.value = this.getAttribute('data-suggestion');
            autoGrow();
            updateCharCounter();
            updateSendBtn();
            chatInput.focus();
        });
    });

    // Sidebar toggle (mobile)
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('visible');
        });
    }

    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('visible');
        });
    }

    // Initial scroll to bottom
    scrollToBottom();
    updateSendBtn();
})();
</script>
{% endblock %}
